{
  "version": "Notebook/1.0",
  "items": [
    {
      "type": 1,
      "content": {
        "json": "# Workspace Commitment Tier Workbook\r\n\r\n[If you have any feedback or issues, please submit them here](https://github.com/TheAlistairRoss/MicrosoftSentinel/issues/new/choose)"
      },
      "name": "text - Main Page - Title"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "255c5943-cfbe-4434-a7b2-9614b8d65b5f",
            "version": "KqlParameterItem/1.0",
            "name": "TimeRange",
            "label": "Time Range",
            "type": 4,
            "description": "Time span of usage logs to be analyzed. Time Range will automatically be truncated to the start of the next  for the start time and end of the previous day for the end time within the queries. This is to ensure complete days for analysis.",
            "isRequired": true,
            "typeSettings": {
              "selectableValues": [
                {
                  "durationMs": 604800000
                },
                {
                  "durationMs": 1209600000
                },
                {
                  "durationMs": 2419200000
                },
                {
                  "durationMs": 2592000000
                },
                {
                  "durationMs": 5184000000
                },
                {
                  "durationMs": 7776000000
                }
              ],
              "allowCustom": true
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "value": {
              "durationMs": 7776000000
            }
          },
          {
            "id": "3b23bed9-9564-467c-aea0-4d2ee76f7e77",
            "version": "KqlParameterItem/1.0",
            "name": "Subscriptions",
            "type": 6,
            "isRequired": true,
            "multiSelect": true,
            "quote": "'",
            "delimiter": ",",
            "query": "resources\r\n| where type =~ \"microsoft.operationalinsights/workspaces\"\r\n| distinct subscriptionId",
            "crossComponentResources": [
              "value::all"
            ],
            "typeSettings": {
              "additionalResourceOptions": [
                "value::all"
              ]
            },
            "defaultValue": "value::all",
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources",
            "value": [
              "value::all"
            ]
          },
          {
            "id": "d766ea1e-e7cb-4c21-9544-ced5c7aeef8d",
            "version": "KqlParameterItem/1.0",
            "name": "Workspace",
            "type": 5,
            "isRequired": true,
            "query": "resources\r\n| where type =~ \"microsoft.operationalinsights/workspaces\"\r\n| project id, name, subscriptionId\r\n| join kind = inner (\r\n    resourcecontainers\r\n    | where type == \"microsoft.resources/subscriptions\"\r\n    | project subscriptionId, subscription = strcat(name,\" (\",subscriptionId,\")\")\r\n)\r\non subscriptionId\r\n|project value = id, label = name, group = subscription",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "4e04e9a7-1da3-4cfe-aa8a-35ad6229606b",
            "version": "KqlParameterItem/1.0",
            "name": "CurrencyCode",
            "type": 2,
            "description": "This is the currency code which your billing account should be billed / charged in",
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n  {\r\n    \"label\": \"USD US dollar\",\r\n    \"value\": \"USD\",\r\n    \"selected\": true\r\n  },\r\n  {\r\n    \"label\": \"AUD Australian dollar\",\r\n    \"value\": \"AUD\"\r\n  },\r\n  {\r\n    \"label\": \"BRL Brazilian real\",\r\n    \"value\": \"BRL\"\r\n  },\r\n  {\r\n    \"label\": \"CAD Canadian dollar\",\r\n    \"value\": \"CAD\"\r\n  },\r\n  {\r\n    \"label\": \"CHF Swiss franc\",\r\n    \"value\": \"CHF\"\r\n  },\r\n  {\r\n    \"label\": \"CNY Chinese yuan\",\r\n    \"value\": \"CNY\"\r\n  },\r\n  {\r\n    \"label\": \"DKK Danish krone\",\r\n    \"value\": \"DKK\"\r\n  },\r\n  {\r\n    \"label\": \"EUR Euro\",\r\n    \"value\": \"EUR\"\r\n  },\r\n  {\r\n    \"label\": \"GBP British pound\",\r\n    \"value\": \"GBP\"\r\n  },\r\n  {\r\n    \"label\": \"INR Indian rupee\",\r\n    \"value\": \"INR\"\r\n  },\r\n  {\r\n    \"label\": \"JPY Japanese yen\",\r\n    \"value\": \"JPY\"\r\n  },\r\n  {\r\n    \"label\": \"KRW Korean won\",\r\n    \"value\": \"KRW\"\r\n  },\r\n  {\r\n    \"label\": \"NOK Norwegian krone\",\r\n    \"value\": \"NOK\"\r\n  },\r\n  {\r\n    \"label\": \"NZD New Zealand dollar\",\r\n    \"value\": \"NZD\"\r\n  },\r\n  {\r\n    \"label\": \"RUB Russian ruble\",\r\n    \"value\": \"RUB\"\r\n  },\r\n  {\r\n    \"label\": \"SEK Swedish krona\",\r\n    \"value\": \"SEK\"\r\n  },\r\n  {\r\n    \"label\": \"TWD Taiwan dollar\",\r\n    \"value\": \"TWD\"\r\n  }\r\n]\r\n",
            "timeContext": {
              "durationMs": 86400000
            },
            "label": "Currency Code"
          },
          {
            "id": "e7fe4e9e-f94c-49ef-aae3-f93bc7cb6cf5",
            "version": "KqlParameterItem/1.0",
            "name": "ShowHelp",
            "label": "Show Help",
            "type": 10,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    {\"value\":\"true\", \"label\": \"Yes\", \"selected\": false},\r\n    {\"value\":\"false\", \"label\": \"No\", \"selected\": true}\r\n]",
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "bd7f3a5a-3a14-46a4-8241-f18615a0e636",
            "version": "KqlParameterItem/1.0",
            "name": "CustomPrices",
            "label": "Input Custom Prices",
            "type": 10,
            "isRequired": true,
            "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n    {\\\"value\\\":\\\"true\\\", \\\"label\\\": \\\"Yes\\\", \\\"selected\\\": false},\\r\\n    {\\\"value\\\":\\\"false\\\", \\\"label\\\": \\\"No\\\", \\\"selected\\\": true}\\r\\n]\",\"transformers\":null}",
            "typeSettings": {
              "additionalResourceOptions": []
            },
            "timeContext": {
              "durationMs": 86400000
            },
            "queryType": 8
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "UseDemoData",
            "label": "Use Demo Data",
            "type": 10,
            "isRequired": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "jsonData": "[\r\n    {\"value\":\"true\", \"label\": \"Yes\", \"selected\": false},\r\n    {\"value\":\"false\", \"label\": \"No\", \"selected\": true}\r\n]",
            "timeContext": {
              "durationMs": 86400000
            },
            "id": "d7c892ef-18c1-487a-b79d-a6ebead177d6"
          },
          {
            "id": "6e2979ef-af24-467a-afc5-13ee2012c838",
            "version": "KqlParameterItem/1.0",
            "name": "PricingModel",
            "type": 2,
            "description": "This defaults to your current pricing model. Change this if you wish to view the pricing on the different pricing model. Note! Switching to Classic from Unified provides no benefit as you cannot downgrade the pricing model once moved.. https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/introducing-the-new-microsoft-sentinel-simplified-pricing/ba-p/3869145",
            "isRequired": true,
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| where id =~ \"{Workspace}\"\r\n| project workspaceId = tolower(id), ServiceType = \"Log Analytics\", sku = tostring(properties.sku.name)\r\n| union (\r\n    resources\r\n    | where type =~ \"microsoft.operationsmanagement/solutions\"\r\n    | where plan.product == \"OMSGallery/SecurityInsights\"\r\n    | where properties.workspaceResourceId has \"{Workspace}\"\r\n    | project workspaceId = tolower(tostring(properties.workspaceResourceId)), ServiceType = \"Sentinel\", sku = trim(' ', tostring(properties.sku.name))\r\n    ) \r\n| extend Packed = pack_dictionary(ServiceType, sku)\r\n| summarize ServiceTypes = make_list(ServiceType), Values = make_bag(Packed) by workspaceId\r\n| project value = iif(\r\n    ServiceTypes has \"Sentinel\", \r\n    iif (Values.Sentinel == \"Unified\", \"Unified\", \"Classic\"),\r\n    \"Log Analytics\" \r\n    )\r\n| extend\r\n    label = value, \r\n    selected = true\r\n| project value, label, selected",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [],
              "showDefault": false
            },
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "a27fb8f0-d361-4039-9d5a-71c86f5a1f79",
            "version": "KqlParameterItem/1.0",
            "name": "WorkspaceLocation",
            "type": 8,
            "isRequired": true,
            "query": "resources\r\n| where id == \"{Workspace:id}\"\r\n| project location\r\n| extend selected = true",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "isHiddenWhenLocked": true,
            "typeSettings": {
              "additionalResourceOptions": [
                "value::1"
              ],
              "showDefault": false
            },
            "queryType": 1
          },
          {
            "id": "c07f70fc-1196-442e-aa8f-8b53e75e5509",
            "version": "KqlParameterItem/1.0",
            "name": "LogAnalyticsCurrentTier",
            "type": 1,
            "isRequired": true,
            "query": "resources\r\n| where type =~ 'microsoft.operationalinsights/workspaces' \r\n| where id has \"{Workspace}\"\r\n| extend logAnalyticsSku   = trim(' ', tostring(properties.sku.name))\r\n| project logAnalyticsTier = case(\r\n    logAnalyticsSku =~ \"pergb2018\", \"Pay-as-you-go\",\r\n    logAnalyticsSku == \"CapacityReservation\", tostring(properties.sku.capacityReservationLevel),\r\n    \"Not Supported in this workbook\"\r\n    )",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "4ea12366-4603-458b-a369-538b7e6a4e78",
            "version": "KqlParameterItem/1.0",
            "name": "SentinelCurrentTierQuery",
            "type": 1,
            "isRequired": true,
            "query": "    resources\r\n    | where type =~ \"microsoft.operationsmanagement/solutions\"\r\n    | where plan.product == \"OMSGallery/SecurityInsights\"\r\n    | where properties.workspaceResourceId has \"{Workspace}\"\r\n    | extend sentinelSku   = trim(' ', tostring(properties.sku.name))\r\n    | extend sentinelTier = case(\r\n        sentinelSku == \"Unified\", \"Pay-as-you-go\",\r\n        sentinelSku == \"PerGB\", \"Pay-as-you-go\",\r\n        sentinelSku == \"CapacityReservation\", tostring(properties.sku.capacityReservationLevel),\r\n        \"Not Supported in this workbook\"\r\n        )\r\n| project sentinelTier\r\n    \r\n\r\n",
            "crossComponentResources": [
              "{Subscriptions}"
            ],
            "isHiddenWhenLocked": true,
            "queryType": 1,
            "resourceType": "microsoft.resourcegraph/resources"
          },
          {
            "id": "ed05ca72-f3c0-4090-b8df-80a3c671ac15",
            "version": "KqlParameterItem/1.0",
            "name": "SentinelCurrentTier",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "SentinelCurrentTierQuery",
                  "operator": "isNotNull",
                  "rightValType": "param",
                  "resultValType": "param",
                  "resultVal": "SentinelCurrentTierQuery"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "Sentinel Not Enabled"
                }
              }
            ]
          },
          {
            "id": "b53b44a9-08a1-406c-92d1-7bc592252ad4",
            "version": "KqlParameterItem/1.0",
            "name": "ShowSentinel",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "PricingModel",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "Log Analytics",
                  "resultValType": "static",
                  "resultVal": "false"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "true"
                }
              }
            ]
          },
          {
            "version": "KqlParameterItem/1.0",
            "name": "ShowLogAnalytics",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "PricingModel",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "Unified",
                  "resultValType": "static",
                  "resultVal": "false"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "true"
                }
              }
            ],
            "id": "85f7fa57-7ff4-4511-bc24-3b6c4c95960e"
          }
        ],
        "style": "pills",
        "queryType": 8
      },
      "name": "parameters - Main Page"
    },
    {
      "type": 1,
      "content": {
        "json": "# Help\r\n\r\nWelcome to my Microsoft Sentinel Commitment Tier workbook. The aim of this workbook is to help you make an informed desicion with regards to changing commitment tiers. These changes can have a negative impact if done incorrectly, but done correctly, they will unlock additional discounts as you ingest more data into you log analytics workspace.\r\n\r\nYou need to ensure that the parameters above are set. Some are hidden and automatically determined, but you will need to ensure the following are set.\r\n\r\n- **Time Range**: This is the time period which you want to analyse in this workbook.\r\n- **Subscriptions**: This is the subscription where your log analytics workspace resides.\r\n- **Workspace**: This is the Log Analytics workspace you are analysing.\r\n- **CurrencyCode**: This should be the currency which you are invoiced. Not everyone can view the billing information, so this is not looked up automatically.\r\n\r\nThe following parameters are optional:\r\n- **Show Help**: You have already pressed this, otherwise you would not be here. This presents helpful information all throughout the workbook.\r\n- **Use Demo Data**: Sometimes to realise value of workbooks, you need to simulate the data. This will change all the usage queries to use a simulated data which makes the recommendation to move to the 100 GB commitment tier. This has only been designed with a workspace at the pay-as-you-go tier.\r\n- **Input Custom Prices**: This gives you the option to input your own custom prices. This is typically used when you have additional discounts applied by Microsoft\r\n\r\n## NOTE: Input Custom Prices - If this option is selected, expand the heading immediatly below and input the values. They will default to zero, so consider saving the workbook to maintain these values.",
        "style": "info"
      },
      "conditionalVisibility": {
        "parameterName": "ShowHelp",
        "comparison": "isEqualTo",
        "value": "true"
      },
      "name": "text - Main Page - Initial Help"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "loadType": "always",
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# Default Parameters\r\n\r\nThese values are always left hidden and not ammended. They are here to force the parameter to have a value, even when not used. To use these parameters. Select the Input Custom Prices parameter."
            },
            "conditionalVisibility": {
              "parameterName": "_",
              "comparison": "isEqualTo",
              "value": "_"
            },
            "name": "text - default custom prices parameters"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "1dd98ee2-bec6-4728-859c-75be9722314e",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorPayasyougo",
                  "label": "Pay-as-you-go",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "47d4951d-d47b-4b44-922c-f41cb601902a",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorOneHundred",
                  "label": "100 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "abea1ff5-c49a-4019-af8b-dffdd6e28cff",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorTwoHundred",
                  "label": "200 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "95fe558a-a0bc-442d-a42d-b5ba74b7c6d3",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorThreeHundred",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "label": "300 GB"
                },
                {
                  "id": "081cde4b-0f37-432d-b54a-a54a7c4c5c25",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorFourHundred",
                  "label": "400 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "a977e58b-3e34-4fd2-aa20-c1b0525c4cb2",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorFiveHundred",
                  "label": "500 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "c50ca221-d1ad-4816-9f90-b0d15f12219b",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorOneThousand",
                  "label": "1000 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "defd265e-554d-4302-988e-373e130c7aed",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorTwoThousand",
                  "label": "2000 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "d8aa9a65-bfec-4b6f-8cb9-d63c99fbbcea",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorFiveThousand",
                  "label": "5000 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - Microsoft Azure Monitor Custom Pricing - Copy"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "9bc05fda-2b6e-49a8-9f23-792041b3bb8d",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorPayasyougo",
                  "label": "Pay-as-you-go",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "471e01c5-5b31-4940-bdac-497c775d1d63",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorOneHundred",
                  "label": "100 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "0f577e1d-ce38-41d0-8e1f-f01438c08d9c",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorTwoHundred",
                  "label": "200 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "f050fcdf-0bd0-4e1d-bb85-2fe165613b07",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorThreeHundred",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "label": "300 GB"
                },
                {
                  "id": "4dc9ad0f-03fa-480e-bda3-7b23244664f9",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorFourHundred",
                  "label": "400 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "c662558c-4744-4463-b80e-93152ed3ded2",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorFiveHundred",
                  "label": "500 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "18b2169e-540e-4b57-b87c-e25749711231",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorOneThousand",
                  "label": "1000 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "d58ddfd7-16f4-46ab-b794-82c2a3794292",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorTwoThousand",
                  "label": "2000 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                },
                {
                  "id": "274b155b-429b-4ef6-b6a4-2403531c26b0",
                  "version": "KqlParameterItem/1.0",
                  "name": "AzureMonitorFiveThousand",
                  "label": "5000 GB",
                  "type": 1,
                  "isRequired": true,
                  "isHiddenWhenLocked": true,
                  "criteriaData": [
                    {
                      "criteriaContext": {
                        "operator": "Default",
                        "resultValType": "static",
                        "resultVal": "0"
                      }
                    }
                  ],
                  "timeContext": {
                    "durationMs": 86400000
                  }
                }
              ],
              "style": "above",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces"
            },
            "name": "parameters - Microsoft Azure Monitor Custom Pricing - Copy"
          }
        ],
        "exportParameters": true
      },
      "name": "group - default prices parameters"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Input Custom Prices",
        "expandable": true,
        "expanded": true,
        "loadType": "always",
        "items": [
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Azure Monitor (Log Analytics) Custom Prices",
              "loadType": "always",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "6af066c5-0264-4f65-9282-062f51967237",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorPayasyougo",
                        "label": "Pay-as-you-go",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "46a84065-0374-4fa4-99f2-fa7056d9fe28",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorOneHundred",
                        "label": "100 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "56f09db4-511a-4bf5-9901-195bddee1cb0",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorTwoHundred",
                        "label": "200 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "5a3d9b06-c3f9-4e1a-b7b8-9b4da712cdf5",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorThreeHundred",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "label": "300 GB"
                      },
                      {
                        "id": "3d1007a4-1a12-49f1-9add-13e62dfbd25f",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorFourHundred",
                        "label": "400 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "e19a4ce7-1dc8-427a-9417-2ddeccfaba8a",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorFiveHundred",
                        "label": "500 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "1ec6113c-a214-46f7-8ced-710933504fd5",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorOneThousand",
                        "label": "1000 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "bdbd1a7c-591e-47e0-9b9d-de0a6014c60b",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorTwoThousand",
                        "label": "2000 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "6c558126-cf68-4282-aad7-49adbc89b147",
                        "version": "KqlParameterItem/1.0",
                        "name": "AzureMonitorFiveThousand",
                        "label": "5000 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "name": "parameters - Microsoft Azure Monitor Custom Pricing"
                }
              ],
              "exportParameters": true
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "ShowLogAnalytics",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "group - Custom Prices - Log Analytics"
          },
          {
            "type": 12,
            "content": {
              "version": "NotebookGroup/1.0",
              "groupType": "editable",
              "title": "Sentinel Custom Prices",
              "loadType": "always",
              "items": [
                {
                  "type": 9,
                  "content": {
                    "version": "KqlParameterItem/1.0",
                    "parameters": [
                      {
                        "id": "6af066c5-0264-4f65-9282-062f51967237",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelPayasyougo",
                        "label": "Pay-as-you-go",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "46a84065-0374-4fa4-99f2-fa7056d9fe28",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelOneHundred",
                        "label": "100 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "56f09db4-511a-4bf5-9901-195bddee1cb0",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelTwoHundred",
                        "label": "200 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "5a3d9b06-c3f9-4e1a-b7b8-9b4da712cdf5",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelThreeHundred",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        },
                        "label": "300 GB"
                      },
                      {
                        "id": "3d1007a4-1a12-49f1-9add-13e62dfbd25f",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelFourHundred",
                        "label": "400 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "e19a4ce7-1dc8-427a-9417-2ddeccfaba8a",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelFiveHundred",
                        "label": "500 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "1ec6113c-a214-46f7-8ced-710933504fd5",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelOneThousand",
                        "label": "1000 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "bdbd1a7c-591e-47e0-9b9d-de0a6014c60b",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelTwoThousand",
                        "label": "2000 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      },
                      {
                        "id": "6c558126-cf68-4282-aad7-49adbc89b147",
                        "version": "KqlParameterItem/1.0",
                        "name": "SentinelFiveThousand",
                        "label": "5000 GB",
                        "type": 1,
                        "isRequired": true,
                        "criteriaData": [
                          {
                            "criteriaContext": {
                              "operator": "Default",
                              "resultValType": "static",
                              "resultVal": "0"
                            }
                          }
                        ],
                        "timeContext": {
                          "durationMs": 86400000
                        }
                      }
                    ],
                    "style": "above",
                    "queryType": 0,
                    "resourceType": "microsoft.operationalinsights/workspaces"
                  },
                  "conditionalVisibility": {
                    "parameterName": "ShowSentinel",
                    "comparison": "isEqualTo",
                    "value": "true"
                  },
                  "name": "parameters - Microsoft Sentinel Custom Pricing"
                }
              ],
              "exportParameters": true
            },
            "customWidth": "50",
            "conditionalVisibility": {
              "parameterName": "ShowSentinel",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "group - Custom Prices - Sentinel"
          }
        ],
        "exportParameters": true
      },
      "conditionalVisibility": {
        "parameterName": "CustomPrices",
        "comparison": "isEqualTo",
        "value": "true"
      },
      "name": "group - Input Custom Prices"
    },
    {
      "type": 1,
      "content": {
        "json": "# DEMO DATA\r\n## This workbook is currently displaying usage data for demonstration purposes. Ensure you turn this parameter off in production",
        "style": "warning"
      },
      "conditionalVisibility": {
        "parameterName": "UseDemoData",
        "comparison": "isEqualTo",
        "value": "true"
      },
      "name": "text - Main Page - Demo Data Warning"
    },
    {
      "type": 1,
      "content": {
        "json": "# Intentionally hidden - URL and Query Parameters\r\n\r\nThese parameters are only used in advanced scenarios. This contain the Urls and queries used for the external data queries and are constructed based on selected parameters. They allow the correct file to be referenced from the selected repository.\r\n\r\nDo not modify these unless you know what you are doing!\r\n\r\n"
      },
      "conditionalVisibility": {
        "parameterName": "_",
        "comparison": "isEqualTo",
        "value": "_"
      },
      "name": "text - 8"
    },
    {
      "type": 9,
      "content": {
        "version": "KqlParameterItem/1.0",
        "parameters": [
          {
            "id": "afbb6ac9-ca43-449f-88ce-6ac8222e116e",
            "version": "KqlParameterItem/1.0",
            "name": "RepositoryURL",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "https://raw.githubusercontent.com/TheAlistairRoss/MicrosoftSentinel/main/Solutions/CostManagement/Prices"
                }
              }
            ],
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "3790a338-3ba9-42c8-8cda-354808853434",
            "version": "KqlParameterItem/1.0",
            "name": "AzureMonitorPricesCSVURL",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "{RepositoryURL}/Classic/Azure%20Monitor/{WorkspaceLocation}/{CurrencyCode}_Prices.csv"
                }
              }
            ],
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "c84a372b-9075-45fe-8255-9a73756e2008",
            "version": "KqlParameterItem/1.0",
            "name": "SentinelPricesCSVURL",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "{RepositoryURL}/{PricingModel}/Sentinel/{WorkspaceLocation}/{CurrencyCode}_Prices.csv"
                }
              }
            ],
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "bd69147c-dc30-4515-9676-4e6e50cbe50d",
            "version": "KqlParameterItem/1.0",
            "name": "AzureMonitorExternalData",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "externaldata(TimeGenerated : datetime , ServiceName: string , ArmRegionName: string, CurrencyCode: string, MeterName: string, Tier: string, UnitOfMeasure: string, RetailPrice: decimal , EffectiveStartDate:datetime , EffectiveCommitmentTierThresholdGB:decimal , EffectivePricePerGB:decimal)[  h\"{AzureMonitorPricesCSVURL}\" ] with(format=\"csv\",ignoreFirstRecord=true)"
                }
              }
            ],
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "69f032a3-1378-424c-be11-f0f6851753d5",
            "version": "KqlParameterItem/1.0",
            "name": "SentinelExternalData",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "externaldata(TimeGenerated : datetime , ServiceName: string , ArmRegionName: string, CurrencyCode: string, MeterName: string, Tier: string, UnitOfMeasure: string, RetailPrice: decimal , EffectiveStartDate:datetime , EffectiveCommitmentTierThresholdGB:decimal , EffectivePricePerGB:decimal)[  h\"{SentinelPricesCSVURL}\" ] with(format=\"csv\",ignoreFirstRecord=true)"
                }
              }
            ],
            "timeContext": {
              "durationMs": 86400000
            }
          },
          {
            "id": "51ff305b-87db-4d58-96d5-5a4979d54ed7",
            "version": "KqlParameterItem/1.0",
            "name": "UsageDataQuery",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "UseDemoData",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "true",
                  "resultValType": "static",
                  "resultVal": "let QuantityList = dynamic([115.95,37.806,37.59,114.276,116.766,113.172,114.684,115.164,37.5,37.542,108.75,116.016,119.868,111.504,111.366,37.164,37.084,113.922,114.384,115.026,115.44,113.706,36.894,36.77,111.852,113.13,116.55,114.726,114.468,37.044,36.908,113.616,114.396,111.426,121.542,114.426,36.356,36.572,112.764,118.56,114.738,113.946,112.086,36.218,36.018,109.56,120.504,110.526,108.708,107.946,35.494,35.634,129.432,110.79,107.766,105.966,104.478,34.194,34.238,103.458,104.448,106.602,105.48,107.988,34.378,34.264,104.544,107.304,111.582,108.438,108.18,36.114,34.698,105.786,108.414,113.196,129.57,109.866,38.388,35.92,111.036,114.792,114.72,111.33,109.284,36.02,35.604,108.756,111.282,113.844]); let UsageMetrics = print Quantity_GB = QuantityList | mv-expand Quantity_GB to typeof(real) | serialize  | extend StartTime = startofday(datetime_add(\"day\", -row_number(), now())) | where StartTime >= TimeRangeStart and StartTime <= TimeRangeEnd | extend JoinColumn = 1;"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "static",
                  "resultVal": "let UsageMetrics =      Usage      | where IsBillable == true      | where StartTime >= TimeRangeStart and StartTime <= TimeRangeEnd     | make-series Quantity = sum(Quantity) default = 0 on StartTime step 1d     | mv-expand Quantity to typeof(long), StartTime to typeof(datetime)     | project Quantity_GB  = (Quantity / 1e3), StartTime     | extend JoinColumn = 1;"
                }
              }
            ]
          },
          {
            "id": "519ab20c-9074-4f23-a485-4cf5aabb0d64",
            "version": "KqlParameterItem/1.0",
            "name": "AzureMonitorPrices",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "ShowLogAnalytics",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "false",
                  "resultValType": "static",
                  "resultVal": "datatable (     OrderIndex: int,     MeterName: string,     Tier: string,     RetailPrice: real )[     0, \"Pay-as-you-go Data Ingestion\", \"Pay-as-you-go\", {AzureMonitorPayasyougo},     1, \"100 GB Commitment Tier Capacity Reservation\", \"100\", {AzureMonitorOneHundred},     2, \"200 GB Commitment Tier Capacity Reservation\", \"200\", {AzureMonitorTwoHundred},     3, \"300 GB Commitment Tier Capacity Reservation\", \"300\", {AzureMonitorThreeHundred},     4, \"400 GB Commitment Tier Capacity Reservation\", \"400\", {AzureMonitorFourHundred},     5, \"500 GB Commitment Tier Capacity Reservation\", \"500\", {AzureMonitorFiveHundred},     6, \"1000 GB Commitment Tier Capacity Reservation\", \"1000\", {AzureMonitorOneThousand},     7, \"2000 GB Commitment Tier Capacity Reservation\", \"2000\", {AzureMonitorTwoThousand},     8, \"5000 GB Commitment Tier Capacity Reservation\", \"5000\", {AzureMonitorFiveThousand} ] | extend EffectivePricePerGB = iff(Tier == \"Pay-as-you-go\", RetailPrice, RetailPrice / toint(Tier)) | project     EffectivePricePerGB = bag_pack(tostring(OrderIndex), EffectivePricePerGB),     DetailsPacked = bag_pack(\"MeterName\", MeterName, \"Tier\", Tier, \"RetailPrice\", RetailPrice, \"OrderIndex\", OrderIndex, \"EffectivePricePerGB\", EffectivePricePerGB) | summarize     Details = make_list(DetailsPacked),     EffectivePricePerGBPacked = make_bag(EffectivePricePerGB) | mv-expand Details | evaluate bag_unpack(Details) : (MeterName:string, Tier:string, RetailPrice:decimal, OrderIndex:int, EffectivePricePerGB:decimal, EffectivePricePerGBPacked :dynamic) | extend EffectiveCommitmentTierThresholdGB = iif(Tier == \"Pay-as-you-go\", todecimal(0), todecimal(round(RetailPrice / todecimal(EffectivePricePerGBPacked[tostring(OrderIndex - 1)]), 4))) | extend ServiceName = \"AzureMonitor\" | extend TimeGenerated = now() | project-away EffectivePricePerGBPacked, OrderIndex"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "CustomPrices",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "true",
                  "resultValType": "static",
                  "resultVal": "datatable (     OrderIndex: int,     MeterName: string,     Tier: string,     RetailPrice: real )[     0, \"Pay-as-you-go Data Ingestion\", \"Pay-as-you-go\", {AzureMonitorPayasyougo},     1, \"100 GB Commitment Tier Capacity Reservation\", \"100\", {AzureMonitorOneHundred},     2, \"200 GB Commitment Tier Capacity Reservation\", \"200\", {AzureMonitorTwoHundred},     3, \"300 GB Commitment Tier Capacity Reservation\", \"300\", {AzureMonitorThreeHundred},     4, \"400 GB Commitment Tier Capacity Reservation\", \"400\", {AzureMonitorFourHundred},     5, \"500 GB Commitment Tier Capacity Reservation\", \"500\", {AzureMonitorFiveHundred},     6, \"1000 GB Commitment Tier Capacity Reservation\", \"1000\", {AzureMonitorOneThousand},     7, \"2000 GB Commitment Tier Capacity Reservation\", \"2000\", {AzureMonitorTwoThousand},     8, \"5000 GB Commitment Tier Capacity Reservation\", \"5000\", {AzureMonitorFiveThousand} ] | extend EffectivePricePerGB = iff(Tier == \"Pay-as-you-go\", RetailPrice, RetailPrice / toint(Tier)) | project     EffectivePricePerGB = bag_pack(tostring(OrderIndex), EffectivePricePerGB),     DetailsPacked = bag_pack(\"MeterName\", MeterName, \"Tier\", Tier, \"RetailPrice\", RetailPrice, \"OrderIndex\", OrderIndex, \"EffectivePricePerGB\", EffectivePricePerGB) | summarize     Details = make_list(DetailsPacked),     EffectivePricePerGBPacked = make_bag(EffectivePricePerGB) | mv-expand Details | evaluate bag_unpack(Details) : (MeterName:string, Tier:string, RetailPrice:decimal, OrderIndex:int, EffectivePricePerGB:decimal, EffectivePricePerGBPacked :dynamic) | extend EffectiveCommitmentTierThresholdGB = iif(Tier == \"Pay-as-you-go\", todecimal(0), todecimal(round(RetailPrice / todecimal(EffectivePricePerGBPacked[tostring(OrderIndex - 1)]), 4))) | extend ServiceName = \"AzureMonitor\" | extend TimeGenerated = now() | project-away EffectivePricePerGBPacked, OrderIndex"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "param",
                  "resultVal": "AzureMonitorExternalData"
                }
              }
            ]
          },
          {
            "id": "ab7ae2d0-13e2-4e04-bfa6-c5a914a2379d",
            "version": "KqlParameterItem/1.0",
            "name": "SentinelPrices",
            "type": 1,
            "isRequired": true,
            "isHiddenWhenLocked": true,
            "criteriaData": [
              {
                "criteriaContext": {
                  "leftOperand": "ShowSentinel",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "false",
                  "resultValType": "static",
                  "resultVal": "datatable (     OrderIndex: int,     MeterName: string,     Tier: string,     RetailPrice: real )[     0, \"Pay-as-you-go Data Ingestion\", \"Pay-as-you-go\", {SentinelPayasyougo},     1, \"100 GB Commitment Tier Capacity Reservation\", \"100\", {SentinelOneHundred},     2, \"200 GB Commitment Tier Capacity Reservation\", \"200\", {SentinelTwoHundred},     3, \"300 GB Commitment Tier Capacity Reservation\", \"300\", {SentinelThreeHundred},     4, \"400 GB Commitment Tier Capacity Reservation\", \"400\", {SentinelFourHundred},     5, \"500 GB Commitment Tier Capacity Reservation\", \"500\", {SentinelFiveHundred},     6, \"1000 GB Commitment Tier Capacity Reservation\", \"1000\", {SentinelOneThousand},     7, \"2000 GB Commitment Tier Capacity Reservation\", \"2000\", {SentinelTwoThousand},     8, \"5000 GB Commitment Tier Capacity Reservation\", \"5000\", {SentinelFiveThousand} ] | extend EffectivePricePerGB = iff(Tier == \"Pay-as-you-go\", RetailPrice, RetailPrice / toint(Tier)) | project     EffectivePricePerGB = bag_pack(tostring(OrderIndex), EffectivePricePerGB),     DetailsPacked = bag_pack(\"MeterName\", MeterName, \"Tier\", Tier, \"RetailPrice\", RetailPrice, \"OrderIndex\", OrderIndex, \"EffectivePricePerGB\", EffectivePricePerGB) | summarize     Details = make_list(DetailsPacked),     EffectivePricePerGBPacked = make_bag(EffectivePricePerGB) | mv-expand Details | evaluate bag_unpack(Details) : (MeterName:string, Tier:string, RetailPrice:decimal, OrderIndex:int, EffectivePricePerGB:decimal, EffectivePricePerGBPacked :dynamic) | extend EffectiveCommitmentTierThresholdGB = iif(Tier == \"Pay-as-you-go\", todecimal(0), todecimal(round(RetailPrice / todecimal(EffectivePricePerGBPacked[tostring(OrderIndex - 1)]), 4))) | extend ServiceName = \"Sentinel\" | extend TimeGenerated = now() | project-away EffectivePricePerGBPacked, OrderIndex"
                }
              },
              {
                "criteriaContext": {
                  "leftOperand": "CustomPrices",
                  "operator": "==",
                  "rightValType": "static",
                  "rightVal": "true",
                  "resultValType": "static",
                  "resultVal": "datatable (     OrderIndex: int,     MeterName: string,     Tier: string,     RetailPrice: real )[     0, \"Pay-as-you-go Data Ingestion\", \"Pay-as-you-go\", {SentinelPayasyougo},     1, \"100 GB Commitment Tier Capacity Reservation\", \"100\", {SentinelOneHundred},     2, \"200 GB Commitment Tier Capacity Reservation\", \"200\", {SentinelTwoHundred},     3, \"300 GB Commitment Tier Capacity Reservation\", \"300\", {SentinelThreeHundred},     4, \"400 GB Commitment Tier Capacity Reservation\", \"400\", {SentinelFourHundred},     5, \"500 GB Commitment Tier Capacity Reservation\", \"500\", {SentinelFiveHundred},     6, \"1000 GB Commitment Tier Capacity Reservation\", \"1000\", {SentinelOneThousand},     7, \"2000 GB Commitment Tier Capacity Reservation\", \"2000\", {SentinelTwoThousand},     8, \"5000 GB Commitment Tier Capacity Reservation\", \"5000\", {SentinelFiveThousand} ] | extend EffectivePricePerGB = iff(Tier == \"Pay-as-you-go\", RetailPrice, RetailPrice / toint(Tier)) | project     EffectivePricePerGB = bag_pack(tostring(OrderIndex), EffectivePricePerGB),     DetailsPacked = bag_pack(\"MeterName\", MeterName, \"Tier\", Tier, \"RetailPrice\", RetailPrice, \"OrderIndex\", OrderIndex, \"EffectivePricePerGB\", EffectivePricePerGB) | summarize     Details = make_list(DetailsPacked),     EffectivePricePerGBPacked = make_bag(EffectivePricePerGB) | mv-expand Details | evaluate bag_unpack(Details) : (MeterName:string, Tier:string, RetailPrice:decimal, OrderIndex:int, EffectivePricePerGB:decimal, EffectivePricePerGBPacked :dynamic) | extend EffectiveCommitmentTierThresholdGB = iif(Tier == \"Pay-as-you-go\", todecimal(0), todecimal(round(RetailPrice / todecimal(EffectivePricePerGBPacked[tostring(OrderIndex - 1)]), 4))) | extend ServiceName = \"Sentinel\" | extend TimeGenerated = now() | project-away EffectivePricePerGBPacked, OrderIndex"
                }
              },
              {
                "criteriaContext": {
                  "operator": "Default",
                  "resultValType": "param",
                  "resultVal": "SentinelExternalData"
                }
              }
            ]
          }
        ],
        "style": "formHorizontal",
        "queryType": 0,
        "resourceType": "microsoft.operationalinsights/workspaces"
      },
      "name": "parameters - Main Page - URL Parameters"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Overview",
        "items": [
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "// Function for building tiles\r\nlet BuildTile = (tileOrder:int, tileTitle: string, tileSubtitle: string, tileLeft: string, tileRight: string, tileBottom: string) {\r\nprint \r\n    TileOrder = tileOrder, \r\n    title = tileTitle,\r\n    subtitle = tileSubtitle,\r\n    left = tileLeft,\r\n    right = tileRight,\r\n    bottom = tileBottom\r\n};\r\n// Commitment Tier Recommendations Query for Status Tile\r\nlet TimeRangeStart = startofday(todatetime({TimeRange:start}), 1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}), -1);\r\nlet PricingModel = \"{PricingModel}\";\r\nlet SentinelCurrentTier = \"{SentinelCurrentTier}\";\r\nlet LogAnalyticsCurrentTier = \"{LogAnalyticsCurrentTier}\";\r\nlet SentinelPriceInputs = {SentinelPrices};\r\nlet LogAnalyticsPriceInputs = {AzureMonitorPrices};\r\nlet PriceInputs = union SentinelPriceInputs, LogAnalyticsPriceInputs \r\n    | summarize arg_max(TimeGenerated, *) by Tier, ServiceName  \r\n    | extend TierVolumeGB = iif(Tier == \"Pay-as-you-go\", 0, toint(Tier))     \r\n    | project ServiceName, Tier, TierVolumeGB, RetailPrice, EffectivePricePerGB, EffectiveCommitmentTierThresholdGB  \r\n    | extend JoinColumn = 1;\r\n{UsageDataQuery} \r\nlet TierStats = UsageMetrics  \r\n    | join kind = inner (PriceInputs) \r\n    on JoinColumn  \r\n    | project Tier, Quantity_GB, EffectivePricePerGB, RetailPrice, TierVolumeGB, ServiceName  \r\n    | extend CostAtTier = iff(Quantity_GB > TierVolumeGB or Tier == \"Pay-as-you-go\", Quantity_GB * EffectivePricePerGB, RetailPrice)  \r\n    | summarize CostAtTier = sum(CostAtTier) by Tier, ServiceName  \r\n    | extend CostAtTier = round(CostAtTier, 2)  \r\n    | extend JoinColumn = 1;\r\nlet TierChange = toscalar(TierStats\r\n| where (ServiceName == \"Sentinel\" and Tier == SentinelCurrentTier and PricingModel in (\"Unified\", \"Classic\")) or (ServiceName == \"Azure Monitor\" and Tier == LogAnalyticsCurrentTier and PricingModel in (\"Classic\", \"Log Analytics\"))\r\n| join kind = inner(TierStats\r\n    | summarize arg_min(CostAtTier, Tier, JoinColumn) by ServiceName)\r\n    on ServiceName\r\n| extend Status = case(\r\n    Tier == Tier1, \"Good\", \"Change Tier\")\r\n| project\r\n    ServiceName,\r\n    Status\r\n| project Pack = pack_all());\r\n//Build Tiles\r\nlet IsCustomDataTile = BuildTile(0, \"Is Custom Prices\", \"\", {CustomPrices}, \"\",\"\" );\r\nlet PricingModelTile = BuildTile(1, \"Pricing Model\", \"\", \"{PricingModel}\", \"\", \"\");\r\nlet IsSentinelEnabledTile = BuildTile( 2, \"Sentinel Enabled\", \"\", {ShowSentinel},\"\",\"\");\r\nlet TierChangeTile = BuildTile(3, strcat(TierChange.['ServiceName'], \" Tier\"), \"Tier Status\", TierChange.['Status'],\"\",\"\");\r\nunion IsCustomDataTile, PricingModelTile, IsSentinelEnabledTile, TierChangeTile\r\n| order by TileOrder asc\r\n",
              "size": 4,
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "title",
                  "formatter": 1
                },
                "leftContent": {
                  "columnMatch": "left",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "icons",
                    "thresholdsGrid": [
                      {
                        "operator": "==",
                        "thresholdValue": "True",
                        "representation": "success",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "False",
                        "representation": "2",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Log Analytics",
                        "representation": "Log",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Classic",
                        "representation": "Disconnect",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Unified",
                        "representation": "Connect",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Good",
                        "representation": "success",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Change Tier",
                        "representation": "3",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "No Value - Input Custom Prices value",
                        "representation": "2",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "unknown",
                        "text": "{0}{1}"
                      }
                    ]
                  }
                },
                "showBorder": false
              }
            },
            "name": "query - 7"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "resources \r\n| where type =~ 'microsoft.operationalinsights/workspaces'\r\n| where id =~ \"{Workspace}\" \r\n| extend workspaceId = tolower(id)\r\n| extend logAnalyticsSku   = trim(' ', tostring(properties.sku.name))\r\n| extend logAnalyticsSkuUpdate = trim(' ', tostring(properties.sku.lastSkuUpdate))\r\n| extend logAnalyticsTier = case(logAnalyticsSku =~ \"pergb2018\", \"Pay-as-you-go\", \"Free, PerNode and Standalone not supported in this workbook\")\r\n| join kind = leftouter(\r\n    resources \r\n    | where type =~ \"microsoft.operationsmanagement/solutions\"\r\n    | where plan.product == \"OMSGallery/SecurityInsights\"\r\n    | where properties.workspaceResourceId startswith \"{Workspace}\"\r\n    | extend workspaceId = tolower(tostring(properties.workspaceResourceId))\r\n    | extend sentinelEnabled = true\r\n    | extend sentinelSku   = trim(' ', tostring(properties.sku.name)), sentinelSkuUpdate = trim(' ', tostring(properties.sku.lastSkuUpdate))\r\n    | extend sentinelTier = case(sentinelSku == \"Unified\", \"Pay-as-you-go\", sentinelSku == \"PerGB\", \"Pay-as-you-go\", sentinelSku == \"CapacityReservation\", tostring(properties.sku.capacityReservationLevel), \"Not Supported in this workbook\")\r\n    | project workspaceId, sentinelEnabled, sentinelSku, sentinelTier, sentinelSkuUpdate\r\n    )\r\n    on workspaceId\r\n| extend sentinelEnabled = iif(isnotnull(sentinelEnabled), true, false)\r\n| extend sentinelSku  = iif(strlen(sentinelSku) > 0, sentinelSku, \"\")\r\n| project workspaceId, logAnalyticsSku, logAnalyticsTier,sentinelEnabled, sentinelSku, sentinelTier\r\n",
              "size": 4,
              "showAnalytics": true,
              "title": "Workspace Details",
              "showRefreshButton": true,
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "logAnalyticsSku",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "pergb2018",
                          "representation": "success",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "warning",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "sentinelEnabled",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "0",
                          "representation": "more",
                          "text": "False"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "1",
                          "representation": "success",
                          "text": "True"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "unknown",
                          "text": "Unknown"
                        }
                      ]
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "workspaceId",
                    "label": "Workspace Id"
                  },
                  {
                    "columnId": "logAnalyticsSku",
                    "label": "Log Analytics Sku"
                  },
                  {
                    "columnId": "logAnalyticsTier",
                    "label": "Log Analytics Tier"
                  },
                  {
                    "columnId": "sentinelEnabled",
                    "label": "Is Sentinel Enabled"
                  },
                  {
                    "columnId": "sentinelSku",
                    "label": "Sentinel Sku"
                  },
                  {
                    "columnId": "sentinelTier",
                    "label": "Sentinel Tier"
                  }
                ]
              }
            },
            "name": "query - Overview - Workspace Details"
          },
          {
            "type": 1,
            "content": {
              "json": "# Commitment Tier Recommendations\r\n\r\nThis table view displays the current tiers for Microsoft Sentinel. It shows the optimal tier to be on based on the selected time range. It does this by calculating the total cost at each tier and returns the cost for the current tier and the lowest price tier in the selected time range. \r\n\r\nBecause of this, the recommended tier may not always be the most optimal if you have recently made changes to data ingestion, such as increasing or decreasing. Always review the charts page\r\n\r\n"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - Unified - Overview - Commitment Tier Recommendations"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}), 1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}), -1);\r\nlet PricingModel = \"{PricingModel}\";\r\nlet SentinelCurrentTier = \"{SentinelCurrentTier}\";\r\nlet LogAnalyticsCurrentTier = \"{LogAnalyticsCurrentTier}\";\r\nlet SentinelPriceInputs = {SentinelPrices};\r\nlet LogAnalyticsPriceInputs = {AzureMonitorPrices};\r\nlet PriceInputs = union SentinelPriceInputs, LogAnalyticsPriceInputs \r\n    | summarize arg_max(TimeGenerated, *) by Tier, ServiceName  \r\n    | extend TierVolumeGB = iif(Tier == \"Pay-as-you-go\", 0, toint(Tier))     \r\n    | project ServiceName, Tier, TierVolumeGB, RetailPrice, EffectivePricePerGB, EffectiveCommitmentTierThresholdGB  \r\n    | extend JoinColumn = 1;\r\n{UsageDataQuery} \r\nlet TierStats = UsageMetrics  \r\n    | join kind = inner (PriceInputs) \r\n    on JoinColumn  \r\n    | project Tier, Quantity_GB, EffectivePricePerGB, RetailPrice, TierVolumeGB, ServiceName  \r\n    | extend CostAtTier = iff(Quantity_GB > TierVolumeGB or Tier == \"Pay-as-you-go\", Quantity_GB * EffectivePricePerGB, RetailPrice)  \r\n    | summarize CostAtTier = sum(CostAtTier) by Tier, ServiceName  \r\n    | extend CostAtTier = round(CostAtTier, 2)  \r\n    | extend JoinColumn = 1;\r\nTierStats\r\n| where (ServiceName == \"Sentinel\" and Tier == SentinelCurrentTier and PricingModel in (\"Unified\", \"Classic\")) or (ServiceName == \"Azure Monitor\" and Tier == LogAnalyticsCurrentTier and PricingModel in (\"Classic\", \"Log Analytics\"))\r\n| join kind = inner(TierStats\r\n    | summarize arg_min(CostAtTier, Tier, JoinColumn) by ServiceName)\r\n    on ServiceName\r\n| extend Status = case(\r\n    Tier == Tier1, \"Good\", \"Change Tier\")\r\n| project-rename \r\n    CurrentTier = Tier,\r\n    RecommendedTier = Tier1,\r\n    CurrentTierCost = CostAtTier,\r\n    RecommendedTierCost = CostAtTier1\r\n| extend CostDifference = RecommendedTierCost - CurrentTierCost\r\n| project\r\n    ServiceName,\r\n    CurrentTier,\r\n    RecommendedTier,\r\n    Status,\r\n    CurrentTierCost,\r\n    RecommendedTierCost,\r\n    CostDifference",
              "size": 4,
              "showAnalytics": true,
              "title": "Commitment Tier Recommendations",
              "timeContextFromParameter": "TimeRange",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Status",
                    "formatter": 18,
                    "formatOptions": {
                      "linkTarget": "CellDetails",
                      "linkIsContextBlade": true,
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "Change Tier",
                          "representation": "3",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "Good",
                          "representation": "success",
                          "text": "{0}{1}"
                        },
                        {
                          "operator": "startsWith",
                          "thresholdValue": "No Value",
                          "representation": "2",
                          "text": "{0}"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "unknown",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "CurrentTierCost",
                    "formatter": 1,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 2
                      }
                    },
                    "tooltipFormat": {
                      "tooltip": "This is your current estimated costs"
                    }
                  },
                  {
                    "columnMatch": "RecommendedTierCost",
                    "formatter": 1,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 2
                      }
                    },
                    "tooltipFormat": {
                      "tooltip": "This is the potential cost if the tier is changed"
                    }
                  },
                  {
                    "columnMatch": "CostDifferences",
                    "formatter": 1,
                    "numberFormat": {
                      "unit": 17,
                      "options": {
                        "style": "decimal",
                        "maximumFractionDigits": 2
                      }
                    }
                  }
                ],
                "labelSettings": [
                  {
                    "columnId": "ServiceName",
                    "label": "Service"
                  },
                  {
                    "columnId": "CurrentTier",
                    "label": "Current Tier"
                  },
                  {
                    "columnId": "RecommendedTier",
                    "label": "Recommended Tier"
                  },
                  {
                    "columnId": "CurrentTierCost",
                    "label": "Current Tier Cost"
                  },
                  {
                    "columnId": "RecommendedTierCost",
                    "label": "Recommended Tier cost"
                  },
                  {
                    "columnId": "CostDifference",
                    "label": "Cost Difference"
                  }
                ]
              },
              "chartSettings": {
                "yAxis": [
                  "CostAtTier"
                ]
              }
            },
            "name": "query - Unified - Overview - Commitment Tier Recommendations"
          }
        ]
      },
      "name": "group - Unified - Overview"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Charts",
        "expandable": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# DEMO DATA\r\n## This workbook is currently displaying usage data for demonstration purposes. Ensure you turn this parameter off in production",
              "style": "warning"
            },
            "conditionalVisibility": {
              "parameterName": "UseDemoData",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - Main Page - Demo Data Warning - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "# Commitment Tier Parameters\r\n\r\nThese charts require the selection of the Commitment tier parameter. By default, the current tier is selected. With the unified pricing model, this tier selection displays the combined price of Log Analytics and Microsoft Sentinel. \r\n\r\n> TIP: You can select all the tiers at once, but it is recommend to select your current tier, the recommended tier and at least one other (the next one up or down). For example if your current tier is 100 and the recommend tier is 200, select 100, 200 and 300. Check the Overview page for the current recommendation based on your selected time range.\r\n\r\n- Details for changing Microsoft Sentinel Commitment Tiers: https://learn.microsoft.com/en-us/azure/sentinel/billing-reduce-costs#set-or-change-pricing-tier\r\n\r\n### All prices shown are based on the current retail prices. This does not account for any discounts you may have been provided. This has been provided as a guide into your data and converted to cost, as opposed to just data ingested\r\n\r\n### This workbook has not been tested against any legacy tiers for Log Analytics or dedicated clusters.",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - help - Charts"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "parameters": [
                {
                  "id": "ba82e042-daaf-4d29-85a8-d87bfe3bbb33",
                  "version": "KqlParameterItem/1.0",
                  "name": "SentinelCT",
                  "label": "Sentinel Commitment Tier",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "resources\r\n| take 1\r\n| project value = dynamic([\"Pay-as-you-go\",\"100\",\"200\",\"300\",\"400\",\"500\",\"1000\",\"2000\",\"5000\"])\r\n| mvexpand with_itemindex = Order value to typeof(string)\r\n| join kind = fullouter (\r\n    resources\r\n    | where type =~ \"microsoft.operationsmanagement/solutions\"\r\n    | where plan.product == \"OMSGallery/SecurityInsights\"\r\n    | where properties.workspaceResourceId has \"{Workspace}\"\r\n    | extend sentinelSku   = trim(' ', tostring(properties.sku.name))\r\n    | project value = case(\r\n        sentinelSku == \"Unified\", \"Pay-as-you-go\",\r\n        sentinelSku == \"PerGB\", \"Pay-as-you-go\",\r\n        sentinelSku == \"CapacityReservation\", tostring(properties.sku.capacityReservationLevel),\r\n        \"Not Supported in this workbook\"\r\n        )\r\n    | extend selected = true\r\n) on value\r\n| project value, label = value, selected, Order\r\n| order by Order asc\r\n\r\n",
                  "crossComponentResources": [
                    "{Subscriptions}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": [
                    "Pay-as-you-go",
                    "100"
                  ]
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "conditionalVisibility": {
              "parameterName": "ShowSentinel",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "parameters - Sentinel"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "parameters": [
                {
                  "id": "ad76436d-135b-499c-ab9f-4c994dbb35d6",
                  "version": "KqlParameterItem/1.0",
                  "name": "LogAnalyticsCT",
                  "label": "Log Analytics Commitment Tier",
                  "type": 2,
                  "isRequired": true,
                  "multiSelect": true,
                  "quote": "'",
                  "delimiter": ",",
                  "query": "resources\r\n| take 1\r\n| project value = dynamic([\"Pay-as-you-go\",\"100\",\"200\",\"300\",\"400\",\"500\",\"1000\",\"2000\",\"5000\"])\r\n| mvexpand with_itemindex = Order value to typeof(string)\r\n| join kind = fullouter (\r\n    resources\r\n    | where type =~ \"microsoft.operationsmanagement/workspaces\"\r\n    | where id =~ \"{Workspace}\"\r\n    | extend sku   = trim(' ', tostring(properties.sku.name))\r\n    | project value = case(\r\n        sku == \"PerGB2018\", \"Pay-as-you-go\",\r\n        sku == \"CapacityReservation\", tostring(properties.sku.capacityReservationLevel),\r\n        \"Not Supported in this workbook\"\r\n        )\r\n    | extend selected = true\r\n) on value\r\n| project value, label = value, selected, Order\r\n| order by Order asc\r\n\r\n",
                  "crossComponentResources": [
                    "{Subscriptions}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": [
                    "Pay-as-you-go",
                    "100"
                  ]
                }
              ],
              "style": "pills",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "conditionalVisibility": {
              "parameterName": "ShowLogAnalytics",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "parameters - Log Analytics"
          },
          {
            "type": 1,
            "content": {
              "json": "# Charts Color Coding\r\n\r\nEach Tier shown in the charts should be color coded as per the below legend. (All except for the forecasting charts which only show one tier at a time)",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - help - Charts Color Coding"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "print series = dynamic([\r\n        {\r\n          \"Tier\": \"Pay-as-you-go\",\r\n          \"Color\": \"Blue\"\r\n        },\r\n        {\r\n          \"Tier\": \"100\",\r\n          \"Color\": \"Orange\"\r\n        },\r\n        {\r\n          \"Tier\": \"200\",\r\n          \"Color\": \"Bright Red\"\r\n        },\r\n        {\r\n          \"Tier\": \"300\",\r\n          \"Color\": \"Turquoise\"\r\n        },\r\n        {\r\n          \"Tier\": \"400\",\r\n          \"Color\": \"Brown\"\r\n        },\r\n        {\r\n          \"Tier\": \"500\",\r\n          \"Color\": \"Purple\"\r\n        },\r\n        {\r\n          \"Tier\": \"1000\",\r\n          \"Color\": \"Green\"\r\n        },\r\n        {\r\n          \"Tier\": \"2000\",\r\n          \"Color\": \"Gray\"\r\n        },\r\n        {\r\n          \"Tier\": \"5000\",\r\n          \"Color\": \"Light Blue\"\r\n        }\r\n        ]\r\n      )\r\n    | mvexpand series\r\n    | evaluate bag_unpack(series)\r\n    | project Tier = tostring(Tier) , Color = tostring(Color)",
              "size": 4,
              "timeContext": {
                "durationMs": 86400000
              },
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "tiles",
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Color",
                    "formatter": 3,
                    "formatOptions": {
                      "palette": "blue"
                    }
                  }
                ]
              },
              "tileSettings": {
                "titleContent": {
                  "columnMatch": "Tier",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "colors",
                    "thresholdsGrid": [
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "text": "{0}{1}"
                      }
                    ]
                  }
                },
                "leftContent": {
                  "columnMatch": "Color",
                  "formatter": 18,
                  "formatOptions": {
                    "thresholdsOptions": "colors",
                    "thresholdsGrid": [
                      {
                        "operator": "==",
                        "thresholdValue": "Blue",
                        "representation": "blue",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Orange",
                        "representation": "orange",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Bright Red",
                        "representation": "redBright",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Turquoise",
                        "representation": "turquoise",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Brown",
                        "representation": "brown",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Purple",
                        "representation": "purple",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Green",
                        "representation": "green",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Gray",
                        "representation": "gray",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "==",
                        "thresholdValue": "Light Blue",
                        "representation": "lightBlue",
                        "text": "{0}{1}"
                      },
                      {
                        "operator": "Default",
                        "thresholdValue": null,
                        "representation": "pink",
                        "text": "{0}{1}"
                      }
                    ]
                  }
                },
                "showBorder": false,
                "sortOrderField": 1
              },
              "graphSettings": {
                "type": 0
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "query - Help - Series Tiles"
          },
          {
            "type": 1,
            "content": {
              "json": "# Sum of Daily Costs\r\n\r\nThis chart show the retail cost for Microsoft Sentinel based on the selected commitment tiers and current usage. \r\n\r\nFor example if you change the parameter **Sentinel Commitment Tier** to *Pay-as-you-go* and *500*, the chart would display two series for each selected tier. Each series would reflect the retail prices that would have been paid based on the selected tiers.\r\n\r\nWhen trying to interpret these costs , the legend shows the total cost for the selected time range, with the most expensive tier on the left and the best value on the right. ",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - help - Daily Costs"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}),1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}),-1);\r\nlet SelectedTiers = dynamic([{SentinelCT}]);\r\nlet PriceInputs = {SentinelPrices}\r\n| summarize arg_max(TimeGenerated, *) by Tier\r\n| extend TierVolumeGB = iif( Tier == \"Pay-as-you-go\", 0, toint(Tier))\r\n| extend JoinColumn = 1;\r\n// UsageMetrics\r\n{UsageDataQuery}\r\nUsageMetrics\r\n| join kind = inner (\r\n    PriceInputs\r\n    | where Tier in (SelectedTiers)\r\n    )\r\n    on JoinColumn\r\n| project-away JoinColumn, JoinColumn1\r\n| extend CostAtTier = iff(Quantity_GB > TierVolumeGB, Quantity_GB * EffectivePricePerGB, RetailPrice)\r\n| make-series CostAtTier = sum(CostAtTier), Quantity_GB = sum(Quantity_GB) on StartTime from TimeRangeStart to TimeRangeEnd step 1d by Tier\r\n| extend MovingAverageFilter = iif(array_length(CostAtTier) < 7, array_length(CostAtTier), 7)\r\n| extend CostMovingAverage = series_fir(CostAtTier, repeat(1, MovingAverageFilter), true, false)\r\n| extend Quantity_GBMovingAverage = series_fir(Quantity_GB, repeat(1, MovingAverageFilter), true, false)\r\n| render timechart ",
              "size": 0,
              "showAnalytics": true,
              "title": "Sum of Daily Sentinel Cost ({CurrencyCode})",
              "timeContextFromParameter": "TimeRange",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "yAxis": [
                  "CostAtTier"
                ],
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "Pay-as-you-go",
                    "color": "blue"
                  },
                  {
                    "seriesName": "100",
                    "color": "orange"
                  },
                  {
                    "seriesName": "200",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "300",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "400",
                    "color": "brown"
                  },
                  {
                    "seriesName": "500",
                    "color": "purple"
                  },
                  {
                    "seriesName": "1000",
                    "color": "green"
                  },
                  {
                    "seriesName": "2000",
                    "color": "gray"
                  },
                  {
                    "seriesName": "5000",
                    "color": "lightBlue"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "minimumFractionDigits": 2,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowSentinel",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "showPin": true,
            "name": "Sentinel Ingestion Metrics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}),1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}),-1);\r\nlet SelectedTiers = dynamic([{LogAnalyticsCT}]);\r\nlet PriceInputs = {AzureMonitorPrices}\r\n| summarize arg_max(TimeGenerated, *) by Tier\r\n| extend TierVolumeGB = iif( Tier == \"Pay-as-you-go\", 0, toint(Tier))\r\n| extend JoinColumn = 1;\r\n// UsageMetrics\r\n{UsageDataQuery}\r\nUsageMetrics\r\n| join kind = inner (\r\n    PriceInputs\r\n    | where Tier in (SelectedTiers)\r\n    )\r\n    on JoinColumn\r\n| project-away JoinColumn, JoinColumn1\r\n| extend CostAtTier = iff(Quantity_GB > TierVolumeGB, Quantity_GB * EffectivePricePerGB, RetailPrice)\r\n| make-series CostAtTier = sum(CostAtTier), Quantity_GB = sum(Quantity_GB) on StartTime from TimeRangeStart to TimeRangeEnd step 1d by Tier\r\n| extend CostMovingAverage = series_fir(CostAtTier, repeat(1, 7), true, false)\r\n| extend Quantity_GBMovingAverage = series_fir(Quantity_GB, repeat(1, 7), true, false)\r\n| render timechart ",
              "size": 0,
              "showAnalytics": true,
              "title": "Sum of Daily Log Analytics Cost ({CurrencyCode})",
              "timeContextFromParameter": "TimeRange",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "yAxis": [
                  "CostAtTier"
                ],
                "seriesLabelSettings": [
                  {
                    "seriesName": "Pay-as-you-go",
                    "color": "blue"
                  },
                  {
                    "seriesName": "100",
                    "color": "orange"
                  },
                  {
                    "seriesName": "200",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "300",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "400",
                    "color": "brown"
                  },
                  {
                    "seriesName": "500",
                    "color": "purple"
                  },
                  {
                    "seriesName": "1000",
                    "color": "green"
                  },
                  {
                    "seriesName": "2000",
                    "color": "gray"
                  },
                  {
                    "seriesName": "5000",
                    "color": "lightBlue"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "minimumFractionDigits": 2,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowLogAnalytics",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "showPin": true,
            "name": "query - Classic - Charts - Log Analytics Ingestion "
          },
          {
            "type": 1,
            "content": {
              "json": "# Moving Average Costs\r\n\r\nThis chart show the moving average costs for Microsoft Sentinel based on the selected commitment tiers and current usage. \r\n\r\nIn statistics, a moving average is a calculation to analyze data points by creating a series of averages of different subsets of the full data set. This is used in this example to smooth out short term fluctuations in the data and to highlight weekly trends\r\n\r\nFor example if you change the parameter **Sentinel Commitment Tier** to *Pay-as-you-go* and *500*, the chart would display two series for each selected tier. Each series would reflect the moving averages cost based on the selected tiers.",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - help - Moving Average Cost"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"1dba5cef-3c62-4614-a76a-f8c7b8e8812c\",\"mergeType\":\"table\",\"leftTable\":\"Sentinel Ingestion Metrics\"}],\"projectRename\":[{\"originalName\":\"[Sentinel Ingestion Metrics].Tier\",\"mergedName\":\"Tier\",\"fromId\":\"1dba5cef-3c62-4614-a76a-f8c7b8e8812c\"},{\"originalName\":\"[Sentinel Ingestion Metrics].StartTime\",\"mergedName\":\"StartTime\",\"fromId\":\"1dba5cef-3c62-4614-a76a-f8c7b8e8812c\"},{\"originalName\":\"[Sentinel Ingestion Metrics].CostMovingAverage\",\"mergedName\":\"CostMovingAverage\",\"fromId\":\"1dba5cef-3c62-4614-a76a-f8c7b8e8812c\"},{\"originalName\":\"[Sentinel Ingestion Metrics].MovingAverageFilter\",\"mergedName\":\"MovingAverageFilter\",\"fromId\":\"unknown\"},{\"originalName\":\"[query - 1].CostAtTier\"},{\"originalName\":\"[Sum of Daily Ingestion Cost ].CostAtTier\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].CostAtTier\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].Quantity_GBMovingAverage\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].Quantity_GB\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].Index\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].CostMovingAverage\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].Tier\"},{\"originalName\":\"[Sentinel Ingestion Metrics].Index\"},{\"originalName\":\"[Sentinel Ingestion Metrics].CostAtTier\"},{\"originalName\":\"[Sentinel Ingestion Metrics].Quantity_GB\"},{\"originalName\":\"[Sentinel Ingestion Metrics].Quantity_GBMovingAverage\"}]}",
              "size": 0,
              "aggregation": 3,
              "title": "Sentinel 7 Day Moving Average Cost ({CurrencyCode})",
              "showRefreshButton": true,
              "queryType": 7,
              "visualization": "timechart",
              "chartSettings": {
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "Pay-as-you-go",
                    "color": "blue"
                  },
                  {
                    "seriesName": "100",
                    "color": "orange"
                  },
                  {
                    "seriesName": "200",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "300",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "400",
                    "color": "brown"
                  },
                  {
                    "seriesName": "500",
                    "color": "purple"
                  },
                  {
                    "seriesName": "1000",
                    "color": "green"
                  },
                  {
                    "seriesName": "2000",
                    "color": "gray"
                  },
                  {
                    "seriesName": "5000",
                    "color": "lightBlue"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "minimumFractionDigits": 2,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowSentinel",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "Sentinel Moving Average"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{\"version\":\"Merge/1.0\",\"merges\":[{\"id\":\"1dba5cef-3c62-4614-a76a-f8c7b8e8812c\",\"mergeType\":\"table\",\"leftTable\":\"query - Classic - Charts - Log Analytics Ingestion \"}],\"projectRename\":[{\"originalName\":\"[query - Classic - Charts - Log Analytics Ingestion ].Tier\",\"mergedName\":\"Tier\",\"fromId\":\"1dba5cef-3c62-4614-a76a-f8c7b8e8812c\"},{\"originalName\":\"[query - Classic - Charts - Log Analytics Ingestion ].StartTime\",\"mergedName\":\"StartTime\",\"fromId\":\"1dba5cef-3c62-4614-a76a-f8c7b8e8812c\"},{\"originalName\":\"[query - Classic - Charts - Log Analytics Ingestion ].CostMovingAverage\",\"mergedName\":\"CostMovingAverage\",\"fromId\":\"1dba5cef-3c62-4614-a76a-f8c7b8e8812c\"},{\"originalName\":\"[query - 1].CostAtTier\"},{\"originalName\":\"[Sum of Daily Ingestion Cost ].CostAtTier\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].CostAtTier\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].Quantity_GBMovingAverage\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].Quantity_GB\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].Index\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].CostMovingAverage\"},{\"originalName\":\"[Sum of Daily Ingestion Cost].Tier\"},{\"originalName\":\"[Sentinel Ingestion Metrics].Index\"},{\"originalName\":\"[Sentinel Ingestion Metrics].CostAtTier\"},{\"originalName\":\"[Sentinel Ingestion Metrics].Quantity_GB\"},{\"originalName\":\"[Sentinel Ingestion Metrics].Quantity_GBMovingAverage\"},{\"originalName\":\"[query - Classic - Log Analytics Ingestion ].CostAtTier\"},{\"originalName\":\"[query - Classic - Log Analytics Ingestion ].Quantity_GB\"},{\"originalName\":\"[query - Classic - Log Analytics Ingestion ].Quantity_GBMovingAverage\"},{\"originalName\":\"[query - Classic - Charts - Log Analytics Ingestion ].CostAtTier\"},{\"originalName\":\"[query - Classic - Charts - Log Analytics Ingestion ].Quantity_GB\"},{\"originalName\":\"[query - Classic - Charts - Log Analytics Ingestion ].Quantity_GBMovingAverage\"}]}",
              "size": 0,
              "aggregation": 3,
              "title": "Log Analytics 7 Day Moving Average Cost ({CurrencyCode})",
              "showRefreshButton": true,
              "queryType": 7,
              "visualization": "timechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Pay-as-you-go",
                    "color": "blue"
                  },
                  {
                    "seriesName": "100",
                    "color": "orange"
                  },
                  {
                    "seriesName": "200",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "300",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "400",
                    "color": "brown"
                  },
                  {
                    "seriesName": "500",
                    "color": "purple"
                  },
                  {
                    "seriesName": "1000",
                    "color": "green"
                  },
                  {
                    "seriesName": "2000",
                    "color": "gray"
                  },
                  {
                    "seriesName": "5000",
                    "color": "lightBlue"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 0,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true,
                      "minimumFractionDigits": 2,
                      "maximumFractionDigits": 2
                    }
                  }
                }
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowLogAnalytics",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "query - Classic - Charts - Log Analytics Moving Average"
          },
          {
            "type": 1,
            "content": {
              "json": "# GB Ingested and Thresholds\r\n\r\nThis chart show the actual and average ingestion of billable data for Microsoft Sentinel. It also visualises the thresholds which the selected commitment tiers become cost effective. \r\n\r\n\r\nFor example if you change the parameter **Sentinel Commitment Tier** to *Pay-as-you-go* and *500*, the chart would display two series for each selected tier. It would also display two series called *\"Actual_Usage_GB\"* and *\"Average_Usage_GB\"*\r\n\r\nIf the Actual_Usage_GB and / or Average_Usage_GB is higher than a displayed commitment tier, then it would be highly likely that moving to the next tier would be cost effective.",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - help - GB Ingested and Thresholds"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}),1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}),-1);\r\nlet SelectedTiers = dynamic([{SentinelCT}]);\r\nlet PriceInputs = {SentinelPrices}\r\n    | summarize arg_max(TimeGenerated, *) by Tier\r\n    | extend TierVolumeGB = iif(Tier == \"Pay-as-you-go\", 0, toint(Tier))\r\n    | where Tier != \"Pay-as-you-go\"\r\n    | where Tier in (SelectedTiers)\r\n    | extend JoinColumn = 1;\r\n// UsageMetrics\r\n{UsageDataQuery}\r\nlet Actual_Usage_GB = \r\n    UsageMetrics\r\n    | make-series Quantity_GB = toreal(round(sum(Quantity_GB),3)) default = toreal(0) on StartTime step 1d // Daily Usage\r\n    | project \r\n        SeriesName = \"Actual_Usage_GB\",\r\n        StartTime,\r\n        Quantity_GB;\r\nlet Average_Usage_GB = \r\n    Actual_Usage_GB\r\n    | extend Stats = series_stats_dynamic(Quantity_GB)\r\n    | project\r\n        SeriesName = \"Average_Usage_GB\",\r\n        StartTime,\r\n        Quantity_GB = repeat(toreal(Stats.avg), array_length(Quantity_GB))\r\n;\r\nlet UsageTimeRange =\r\n    toscalar(Actual_Usage_GB\r\n    | project StartTime);\r\nlet CommitmentTierCalculations = PriceInputs\r\n    | extend StartTime = UsageTimeRange\r\n    | extend Quantity_GB = repeat(toreal(EffectiveCommitmentTierThresholdGB), array_length(StartTime))\r\n    | project \r\n        SeriesName = tostring(Tier), \r\n        StartTime, \r\n        Quantity_GB\r\n;\r\nunion CommitmentTierCalculations, Actual_Usage_GB, Average_Usage_GB\r\n| render timechart ",
              "size": 0,
              "showAnalytics": true,
              "title": "Sentinel GB Ingested and Commitment Tier Thresholds",
              "timeContextFromParameter": "TimeRange",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "Pay-as-you-go",
                    "color": "blue"
                  },
                  {
                    "seriesName": "100",
                    "color": "orange"
                  },
                  {
                    "seriesName": "200",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "300",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "400",
                    "color": "brown"
                  },
                  {
                    "seriesName": "500",
                    "color": "purple"
                  },
                  {
                    "seriesName": "1000",
                    "color": "green"
                  },
                  {
                    "seriesName": "2000",
                    "color": "gray"
                  },
                  {
                    "seriesName": "5000",
                    "color": "lightBlue"
                  },
                  {
                    "seriesName": "Actual_Usage_GB",
                    "label": "Actual Usage GB",
                    "color": "amethyst"
                  },
                  {
                    "seriesName": "Average_Usage_GB",
                    "label": "Average Usage GB",
                    "color": "pink"
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowSentinel",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "showPin": true,
            "name": "Sentinel GB Ingested and Commitment Tier Thresholds"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}),1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}),-1);\r\nlet SelectedTiers = dynamic([{LogAnalyticsCT}]);\r\nlet PriceInputs = {AzureMonitorPrices}\r\n    | summarize arg_max(TimeGenerated, *) by Tier\r\n    | extend TierVolumeGB = iif(Tier == \"Pay-as-you-go\", 0, toint(Tier))\r\n    | where Tier != \"Pay-as-you-go\"\r\n    | where Tier in (SelectedTiers)\r\n    | extend JoinColumn = 1;\r\n// UsageMetrics\r\n{UsageDataQuery}\r\nlet Actual_Usage_GB = \r\n    UsageMetrics\r\n    | make-series Quantity_GB = toreal(round(sum(Quantity_GB),3)) default = toreal(0) on StartTime step 1d // Daily Usage\r\n    | project \r\n        SeriesName = \"Actual_Usage_GB\",\r\n        StartTime,\r\n        Quantity_GB;\r\nlet Average_Usage_GB = \r\n    Actual_Usage_GB\r\n    | extend Stats = series_stats_dynamic(Quantity_GB)\r\n    | project\r\n        SeriesName = \"Average_Usage_GB\",\r\n        StartTime,\r\n        Quantity_GB = repeat(toreal(Stats.avg), array_length(Quantity_GB))\r\n;\r\nlet UsageTimeRange =\r\n    toscalar(Actual_Usage_GB\r\n    | project StartTime);\r\nlet CommitmentTierCalculations = PriceInputs\r\n    | extend StartTime = UsageTimeRange\r\n    | extend Quantity_GB = repeat(toreal(EffectiveCommitmentTierThresholdGB), array_length(StartTime))\r\n    | project \r\n        SeriesName = tostring(Tier), \r\n        StartTime, \r\n        Quantity_GB\r\n;\r\nunion CommitmentTierCalculations, Actual_Usage_GB, Average_Usage_GB\r\n| render timechart ",
              "size": 0,
              "showAnalytics": true,
              "title": "Log Analytics GB Ingested and Commitment Tier Thresholds",
              "timeContextFromParameter": "TimeRange",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "Pay-as-you-go",
                    "color": "blue"
                  },
                  {
                    "seriesName": "100",
                    "color": "orange"
                  },
                  {
                    "seriesName": "200",
                    "color": "redBright"
                  },
                  {
                    "seriesName": "300",
                    "color": "turquoise"
                  },
                  {
                    "seriesName": "400",
                    "color": "brown"
                  },
                  {
                    "seriesName": "500",
                    "color": "purple"
                  },
                  {
                    "seriesName": "1000",
                    "color": "green"
                  },
                  {
                    "seriesName": "2000",
                    "color": "gray"
                  },
                  {
                    "seriesName": "5000",
                    "color": "lightBlue"
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowLogAnalytics",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "showPin": true,
            "name": "query - Classic - Charts - Log Analytics GB Ingested and Commitment Tier Thresholds"
          }
        ]
      },
      "name": "group - Unified - Charts"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Forecasting",
        "expandable": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "# DEMO DATA\r\n## This workbook is currently displaying usage data for demonstration purposes. Ensure you turn this parameter off in production",
              "style": "warning"
            },
            "conditionalVisibility": {
              "parameterName": "UseDemoData",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - Main Page - Demo Data Warning - Copy"
          },
          {
            "type": 1,
            "content": {
              "json": "# GB Pricing Forecasted\r\n\r\nThese charts show the current ingestion cost the forecasted ingestion costs based of billable data for Microsoft Sentinel. It also visualises the thresholds which the selected commitment tiers become cost effective. \r\n\r\nThese charts require you to select the Microsoft Sentinel tiers that will be displayed for forecasting. By default the current tier will be selected.\r\n\r\nYou are also required to select a value from the parameter **Days Forecasted**.\r\n\r\nWhen making forecasting predictions, the more data you have historically, the more accurate the forecasting is. It is also worth noting the further in the future the data goes, the less accurate the prediction is.\r\n\r\nWhen observing these charts, you will see two series. \r\n- **CostAtTier**: This represents the current cost based on the pricing unputs and current usage. At the end of the selected time range, it will drop to 0.\r\n- **Forecasted**: This reflects the trend of data, with anomalous data samples removed. This is why it does not match the *CostAtTier* series exactly. At the end of the selected time range, it will continue further for the number of days selected in the parameter **Days Forecasted**, providing a calculated prection of the data based on historcal data.\r\n\r\n>Note: Forecasting cannot predict for unexpected changes that have not happened regularlly in the historical data, such as onboarding of new data sources. Also if seasonality cannot be detected (This means regular patterns, such as peaks and troughs in the data relating to user working hours), then it will display a line of best fit.",
              "style": "info"
            },
            "conditionalVisibility": {
              "parameterName": "ShowHelp",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "text - help - Pricing Forecasted"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "parameters": [
                {
                  "id": "b8bed91f-6531-4010-ba00-1856d2c62617",
                  "version": "KqlParameterItem/1.0",
                  "name": "DaysInFuture",
                  "label": "Days Forecasted",
                  "type": 10,
                  "isRequired": true,
                  "query": "{\"version\":\"1.0.0\",\"content\":\"[\\r\\n    {\\r\\n        \\\"value\\\":  1,\\r\\n        \\\"label\\\":  \\\"1 days\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\":  2,\\r\\n        \\\"label\\\":  \\\"2 days\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\":  3,\\r\\n        \\\"label\\\":  \\\"3 days\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\":  4,\\r\\n        \\\"label\\\":  \\\"4 days\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\":  5,\\r\\n        \\\"label\\\":  \\\"5 days\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\":  6,\\r\\n        \\\"label\\\":  \\\"6 days\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"label\\\":  \\\"1 week\\\",\\r\\n        \\\"selected\\\":  true,\\r\\n        \\\"value\\\":  7\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\":  14,\\r\\n        \\\"label\\\":  \\\"2 Weeks\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\":  21,\\r\\n        \\\"label\\\":  \\\"3 Weeks\\\"\\r\\n    },\\r\\n    {\\r\\n        \\\"value\\\":  28,\\r\\n        \\\"label\\\":  \\\"4 Weeks\\\"\\r\\n    },\\r\\n\\t    {\\r\\n        \\\"value\\\":  56,\\r\\n        \\\"label\\\":  \\\"8 Weeks\\\"\\r\\n    },\\r\\n\\t    {\\r\\n        \\\"value\\\":  84,\\r\\n        \\\"label\\\":  \\\"12 Weeks\\\"\\r\\n    }\\r\\n]\\r\\n\",\"transformers\":null}",
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "queryType": 8,
                  "value": "84"
                }
              ],
              "style": "above",
              "queryType": 8
            },
            "name": "parameters - 15"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "parameters": [
                {
                  "id": "2e6952da-1530-4fdd-8ba2-a5b3328f5260",
                  "version": "KqlParameterItem/1.0",
                  "name": "SentinelSelectedForecastTier",
                  "label": "Sentinel Tier",
                  "type": 10,
                  "isRequired": true,
                  "query": "resources\r\n| take 1\r\n| project value = dynamic([\"Pay-as-you-go\",\"100\",\"200\",\"300\",\"400\",\"500\",\"1000\",\"2000\",\"5000\"])\r\n| mvexpand with_itemindex = Order value to typeof(string)\r\n| join kind = fullouter (\r\n    resources\r\n    | where type =~ \"microsoft.operationsmanagement/solutions\"\r\n    | where plan.product == \"OMSGallery/SecurityInsights\"\r\n    | where properties.workspaceResourceId has \"{Workspace}\"\r\n    | extend sentinelSku   = trim(' ', tostring(properties.sku.name))\r\n    | project value = case(\r\n        sentinelSku == \"Unified\", \"Pay-as-you-go\",\r\n        sentinelSku == \"PerGB\", \"Pay-as-you-go\",\r\n        sentinelSku == \"CapacityReservation\", tostring(properties.sku.capacityReservationLevel),\r\n        \"Not Supported in this workbook\"\r\n        )\r\n    | extend selected = true\r\n) on value\r\n| project value, label = value, selected, Order\r\n| order by Order asc\r\n\r\n",
                  "crossComponentResources": [
                    "{Subscriptions}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": "100"
                }
              ],
              "style": "above",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "conditionalVisibility": {
              "parameterName": "ShowSentinel",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "parameters - Forecasting - Sentinel"
          },
          {
            "type": 9,
            "content": {
              "version": "KqlParameterItem/1.0",
              "crossComponentResources": [
                "{Subscriptions}"
              ],
              "parameters": [
                {
                  "id": "59049206-5f1b-4f13-ad47-815fb2764e0f",
                  "version": "KqlParameterItem/1.0",
                  "name": "LogAnalyticsSelectedForecastTier",
                  "label": "LogAnalyticsTier",
                  "type": 10,
                  "isRequired": true,
                  "query": "resources\r\n| take 1\r\n| project value = dynamic([\"Pay-as-you-go\",\"100\",\"200\",\"300\",\"400\",\"500\",\"1000\",\"2000\",\"5000\"])\r\n| mvexpand with_itemindex = Order value to typeof(string)\r\n| join kind = fullouter (\r\n    resources\r\n    | where type =~ \"microsoft.operationsmanagement/solutions\"\r\n    | where plan.product == \"OMSGallery/SecurityInsights\"\r\n    | where properties.workspaceResourceId has \"{Workspace}\"\r\n    | extend sentinelSku   = trim(' ', tostring(properties.sku.name))\r\n    | project value = case(\r\n        sentinelSku == \"Unified\", \"Pay-as-you-go\",\r\n        sentinelSku == \"PerGB\", \"Pay-as-you-go\",\r\n        sentinelSku == \"CapacityReservation\", tostring(properties.sku.capacityReservationLevel),\r\n        \"Not Supported in this workbook\"\r\n        )\r\n    | extend selected = true\r\n) on value\r\n| project value, label = value, selected, Order\r\n| order by Order asc\r\n\r\n",
                  "crossComponentResources": [
                    "{Subscriptions}"
                  ],
                  "typeSettings": {
                    "additionalResourceOptions": [],
                    "showDefault": false
                  },
                  "timeContext": {
                    "durationMs": 86400000
                  },
                  "queryType": 1,
                  "resourceType": "microsoft.resourcegraph/resources",
                  "value": "100"
                }
              ],
              "style": "above",
              "queryType": 1,
              "resourceType": "microsoft.resourcegraph/resources"
            },
            "conditionalVisibility": {
              "parameterName": "ShowLogAnalytics",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "name": "parameters - Forecasting - Log Analytics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}),1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}),-1);\r\nlet DaysForecastedPastEnd = {DaysInFuture};\r\nlet SelectedTier = \"{SentinelSelectedForecastTier}\";\r\nlet PriceInputs = {SentinelPrices}\r\n| where Tier == SelectedTier\r\n| extend TierVolumeGB = iif( Tier == \"Pay-as-you-go\", 0, toint(Tier))\r\n| extend JoinColumn = 1;\r\n// UsageMetrics\r\n{UsageDataQuery}\r\nUsageMetrics\r\n| make-series Quantity_GB = sum(Quantity_GB) on StartTime from TimeRangeStart to datetime_add('Day', DaysForecastedPastEnd, TimeRangeEnd) step 1d \r\n| extend Quantity_GB_Forecasted = series_decompose_forecast(Quantity_GB, DaysForecastedPastEnd, -1,'avg')\r\n| render timechart\r\n| mv-expand\r\n    Quantity_GB to typeof(real),\r\n    Quantity_GB_Forecasted to typeof(real),\r\n    StartTime to typeof(datetime)\r\n| extend JoinColumn = 1\r\n| join kind = inner (\r\n    PriceInputs\r\n    )\r\n    on JoinColumn\r\n| project StartTime, Quantity_GB, Tier, Quantity_GB_Forecasted, TierVolumeGB, EffectivePricePerGB, RetailPrice\r\n| extend CostAtTier = iif(Quantity_GB > TierVolumeGB or Tier == \"Pay-as-you-go\", toreal(Quantity_GB * EffectivePricePerGB), toreal(RetailPrice))\r\n| extend CostAtTier_Forecasted = iff(Quantity_GB_Forecasted > TierVolumeGB or Tier == \"Pay-as-you-go\", toreal(Quantity_GB_Forecasted * EffectivePricePerGB), toreal(RetailPrice))\r\n| make-series CostAtTier = any(CostAtTier), Forecasted = any(CostAtTier_Forecasted) on StartTime from TimeRangeStart to datetime_add('Day', DaysForecastedPastEnd, TimeRangeEnd) step 1d \r\n| render timechart \r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Sentinel Forecasted Cost for Tier \"{SentinelSelectedForecastTier}\" in {CurrencyCode}",
              "timeContextFromParameter": "TimeRange",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "chartSettings": {
                "showLegend": true,
                "seriesLabelSettings": [
                  {
                    "seriesName": "CostAtTier",
                    "label": "Current Cost",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Forecasted",
                    "label": "Forecasted Cost",
                    "color": "pink"
                  }
                ],
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowSentinel",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "showPin": true,
            "name": "Sentinel Forecasted Cost"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}),1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}),-1);\r\nlet DaysForecastedPastEnd = {DaysInFuture};\r\nlet SelectedTier = \"{LogAnalyticsSelectedForecastTier}\";\r\nlet PriceInputs = {AzureMonitorPrices}\r\n| where Tier == SelectedTier\r\n| extend TierVolumeGB = iif( Tier == \"Pay-as-you-go\", 0, toint(Tier))\r\n| extend JoinColumn = 1;\r\n// UsageMetrics\r\n{UsageDataQuery}\r\nUsageMetrics\r\n| make-series Quantity_GB = sum(Quantity_GB) on StartTime from TimeRangeStart to datetime_add('Day', DaysForecastedPastEnd, TimeRangeEnd) step 1d \r\n| extend Quantity_GB_Forecasted = series_decompose_forecast(Quantity_GB, DaysForecastedPastEnd, -1,'avg')\r\n| render timechart\r\n| mv-expand\r\n    Quantity_GB to typeof(real),\r\n    Quantity_GB_Forecasted to typeof(real),\r\n    StartTime to typeof(datetime)\r\n| extend JoinColumn = 1\r\n| join kind = inner (\r\n    PriceInputs\r\n    )\r\n    on JoinColumn\r\n| project StartTime, Quantity_GB, Tier, Quantity_GB_Forecasted, TierVolumeGB, EffectivePricePerGB, RetailPrice\r\n| extend CostAtTier = iif(Quantity_GB > TierVolumeGB or Tier == \"Pay-as-you-go\", toreal(Quantity_GB * EffectivePricePerGB), toreal(RetailPrice))\r\n| extend CostAtTier_Forecasted = iff(Quantity_GB_Forecasted > TierVolumeGB or Tier == \"Pay-as-you-go\", toreal(Quantity_GB_Forecasted * EffectivePricePerGB), toreal(RetailPrice))\r\n| make-series CostAtTier = any(CostAtTier), Forecasted = any(CostAtTier_Forecasted) on StartTime from TimeRangeStart to datetime_add('Day', DaysForecastedPastEnd, TimeRangeEnd) step 1d \r\n| render timechart \r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Log Analytics Forecasted Cost for Tier \"{LogAnalyticsSelectedForecastTier}\" in {CurrencyCode}",
              "timeContextFromParameter": "TimeRange",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "chartSettings": {
                "ySettings": {
                  "numberFormatSettings": {
                    "unit": 17,
                    "options": {
                      "style": "decimal",
                      "useGrouping": true
                    }
                  }
                }
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowLogAnalytics",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "showPin": true,
            "name": "query - Forecasting - Log Analytics"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}),1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}),-1);\r\nlet DaysForecastedPastEnd = {DaysInFuture};\r\nlet SelectedTier = \"{SentinelSelectedForecastTier}\";\r\nlet PriceInputs = {SentinelPrices}\r\n| where Tier == SelectedTier\r\n| extend TierVolumeGB = iif( Tier == \"Pay-as-you-go\", 0, toint(Tier))\r\n| extend JoinColumn = 1;\r\n// UsageMetrics\r\n{UsageDataQuery}\r\nUsageMetrics\r\n| make-series Quantity_GB = sum(Quantity_GB) on StartTime from TimeRangeStart to datetime_add('Day', DaysForecastedPastEnd, TimeRangeEnd) step 1d \r\n| extend Quantity_GB_Forecasted = series_decompose_forecast(Quantity_GB, DaysForecastedPastEnd, -1,'avg')\r\n| render timechart\r\n| mv-expand\r\n    Quantity_GB to typeof(real),\r\n    Quantity_GB_Forecasted to typeof(real),\r\n    StartTime to typeof(datetime)\r\n| extend JoinColumn = 1\r\n| join kind = inner (\r\n    PriceInputs\r\n    )\r\n    on JoinColumn\r\n| project StartTime, Quantity_GB, Tier, Quantity_GB_Forecasted, TierVolumeGB, EffectivePricePerGB, RetailPrice\r\n| extend CostAtTier = iif(Quantity_GB > TierVolumeGB or Tier == \"Pay-as-you-go\", toreal(Quantity_GB * EffectivePricePerGB), toreal(RetailPrice))\r\n| extend CostAtTier_Forecasted = iff(Quantity_GB_Forecasted > TierVolumeGB or Tier == \"Pay-as-you-go\", toreal(Quantity_GB_Forecasted * EffectivePricePerGB), toreal(RetailPrice))\r\n| make-series CostAtTier = any(CostAtTier), Forecasted = any(CostAtTier_Forecasted) on StartTime from TimeRangeStart to datetime_add('Day', DaysForecastedPastEnd, TimeRangeEnd) step 1d \r\n| extend CostAtTier = series_fir(CostAtTier, repeat(1, 7), true, false)\r\n| extend Forecasted = series_fir(Forecasted, repeat(1, 7), true, false)\r\n| render timechart \r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Sentinel Forecasted 7 Day Moving Average Cost for Tier \"{SentinelSelectedForecastTier}\" in {CurrencyCode}",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart",
              "chartSettings": {
                "seriesLabelSettings": [
                  {
                    "seriesName": "CostAtTier",
                    "label": "Current Moving Average",
                    "color": "blue"
                  },
                  {
                    "seriesName": "Forecasted",
                    "label": "Forecasted Moving Average",
                    "color": "pink"
                  }
                ]
              }
            },
            "conditionalVisibility": {
              "parameterName": "ShowSentinel",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "showPin": true,
            "name": "Sentinel Forecasted 7 Day Moving Average"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let TimeRangeStart = startofday(todatetime({TimeRange:start}),1);\r\nlet TimeRangeEnd = endofday(todatetime({TimeRange:end}),-1);\r\nlet DaysForecastedPastEnd = {DaysInFuture};\r\nlet SelectedTier = \"{LogAnalyticsSelectedForecastTier}\";\r\nlet PriceInputs = {AzureMonitorPrices}\r\n| where Tier == SelectedTier\r\n| extend TierVolumeGB = iif( Tier == \"Pay-as-you-go\", 0, toint(Tier))\r\n| extend JoinColumn = 1;\r\n// UsageMetrics\r\n{UsageDataQuery}\r\nUsageMetrics\r\n| make-series Quantity_GB = sum(Quantity_GB) on StartTime from TimeRangeStart to datetime_add('Day', DaysForecastedPastEnd, TimeRangeEnd) step 1d \r\n| extend Quantity_GB_Forecasted = series_decompose_forecast(Quantity_GB, DaysForecastedPastEnd, -1,'avg')\r\n| render timechart\r\n| mv-expand\r\n    Quantity_GB to typeof(real),\r\n    Quantity_GB_Forecasted to typeof(real),\r\n    StartTime to typeof(datetime)\r\n| extend JoinColumn = 1\r\n| join kind = inner (\r\n    PriceInputs\r\n    )\r\n    on JoinColumn\r\n| project StartTime, Quantity_GB, Tier, Quantity_GB_Forecasted, TierVolumeGB, EffectivePricePerGB, RetailPrice\r\n| extend CostAtTier = iif(Quantity_GB > TierVolumeGB or Tier == \"Pay-as-you-go\", toreal(Quantity_GB * EffectivePricePerGB), toreal(RetailPrice))\r\n| extend CostAtTier_Forecasted = iff(Quantity_GB_Forecasted > TierVolumeGB or Tier == \"Pay-as-you-go\", toreal(Quantity_GB_Forecasted * EffectivePricePerGB), toreal(RetailPrice))\r\n| make-series CostAtTier = any(CostAtTier), Forecasted = any(CostAtTier_Forecasted) on StartTime from TimeRangeStart to datetime_add('Day', DaysForecastedPastEnd, TimeRangeEnd) step 1d \r\n| extend CostAtTier = series_fir(CostAtTier, repeat(1, 7), true, false)\r\n| extend Forecasted = series_fir(Forecasted, repeat(1, 7), true, false)\r\n| render timechart \r\n\r\n",
              "size": 0,
              "showAnalytics": true,
              "title": "Log Analytics Forecasted 7 Day Moving Average Cost for Tier \"{LogAnalyticsSelectedForecastTier}\" in {CurrencyCode}",
              "showRefreshButton": true,
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "visualization": "timechart"
            },
            "conditionalVisibility": {
              "parameterName": "ShowLogAnalytics",
              "comparison": "isEqualTo",
              "value": "true"
            },
            "showPin": true,
            "name": "Log Analytics Forecasted 7 Day Moving Average - Copy"
          }
        ]
      },
      "name": "group - Unified - Forecasting"
    },
    {
      "type": 12,
      "content": {
        "version": "NotebookGroup/1.0",
        "groupType": "editable",
        "title": "Troubleshooting",
        "expandable": true,
        "items": [
          {
            "type": 1,
            "content": {
              "json": "This troubleshooting guide takes you through the steps for resolving the external pricing data. For all other issues, ensure you have read access to you Azure Log Analytics workspace were Microsoft Sentinel resides.\r\n\r\nRead access is also required to Microsoft Sentinel, if the workspace is enabled with Microsoft Sentinel.",
              "style": "info"
            },
            "name": "text - Classic - Troubleshooting - Help"
          },
          {
            "type": 1,
            "content": {
              "json": "This troubleshooting table displays the following information\r\n\r\n- **ServiceName** : This will either be \"Azure Monitor\" or \"Sentinel\". \r\n\t- If you are expecting Sentinel to be display and it is not, review your permissions.\r\n\r\n\r\n- **PricingModel** :This will be either \"Unified\",  \"Classic\" or \"Log Analytics\"\r\n\t- **Unified** will show if you have a Microsoft Sentinel enabled workspace on the [new pricing model](https://techcommunity.microsoft.com/t5/microsoft-sentinel-blog/introducing-the-new-microsoft-sentinel-simplified-pricing/ba-p/3869145#:~:text=We%20are%20excited%20to%20announce%20the%20new%20simplified,is%20rolling%20out%20for%20all%20regions%20throughout%20July.).\r\n\t- **Classic** will show if you have not moved to the new pricing model.\r\n\t- **Log Analytics** will show if Microsoft Sentinel is not enabled on your workspace **OR** you do not have read permissions to the SecurityInsights solution.\r\n\r\n\r\n- **CurrencyCode**: This is your selected currency code. The currency codes are as per the [supported currencies](https://learn.microsoft.com/en-us/rest/api/cost-management/retail-prices/azure-retail-prices#supported-currencies).\r\n\r\n\r\n- **ArmRegionName**: This should be the Azure Region name for your Log Analytics Workspace.\r\n\r\n\r\n- **IsData**: This validates that the data can be loaded with the [External Data](https://learn.microsoft.com/en-us/azure/data-explorer/kusto/query/externaldata-operator?pivots=azuremonitor) function.\r\n\r\n\r\n- **Url**: This is the url for the repository where the pricing will be looked up from. You should be able to follow the link and view the raw CSV. \r\n\r\nIf the url does not work, identify the fault (if possible) or submit an issue [here](https://github.com/TheAlistairRoss/MicrosoftSentinel/issues). Ensure you provide all the details shown in the table below.\r\n\r\nIf the results shows a warning message, this may suggests that the external data query has not been loaded as the url is incorrect or the file is inaccessible. Identify which URL is failing. This can be done by observing the **IsData** column and looking for those that are **False**. If possible, try and identify the issue and submit all the details from the table [here](https://github.com/TheAlistairRoss/MicrosoftSentinel/issues). ",
              "style": "info"
            },
            "name": "text - Classic - Troubleshooting - Url Help"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "let sentinelData = {SentinelExternalData};\r\nlet azureMonitorData = {AzureMonitorExternalData};\r\nlet currencyCode = \"{CurrencyCode}\";\r\nlet armRegionName = \"{WorkspaceLocation}\";\r\nlet Service = dynamic([{\"ServiceName\": \"Sentinel\", \"Url\" : \"{SentinelPricesCSVURL}\"},{\"ServiceName\": \"Azure Monitor\", \"Url\" : \"{AzureMonitorPricesCSVURL}\"}]);\r\nlet externalDataTest = union azureMonitorData, sentinelData\r\n    | distinct ServiceName\r\n    | extend IsData = true;\r\nprint\r\n    ServiceName = Service,\r\n    CurrencyCode = currencyCode,\r\n    ArmRegionName = armRegionName \r\n| mvexpand ServiceName\r\n | evaluate bag_unpack(ServiceName)\r\n| join kind=fullouter (externalDataTest) on ServiceName\r\n| project-away ServiceName1\r\n| extend IsData = iif(IsData == true, true, false)\r\n| extend PricingModel = \"{PricingModel}\"\r\n| extend Info = \"info\"\r\n| order by ServiceName asc\r\n| project Info, ServiceName, PricingModel, CurrencyCode, ArmRegionName, IsData, Url\r\n",
              "size": 4,
              "showAnalytics": true,
              "title": "URL Details",
              "timeContextFromParameter": "TimeRange",
              "showExportToExcel": true,
              "exportToExcelOptions": "all",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "Info",
                    "formatter": 11,
                    "formatOptions": {
                      "linkTarget": "GenericDetails",
                      "linkIsContextBlade": true,
                      "customColumnWidthSetting": "16ch"
                    }
                  },
                  {
                    "columnMatch": "ServiceName",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "19ch"
                    },
                    "tooltipFormat": {
                      "tooltip": "'Azure Monitor' or 'Sentinel'"
                    }
                  },
                  {
                    "columnMatch": "CurrencyCode",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "USD",
                          "text": "{0}{1} ($)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "AUD",
                          "text": "{0}{1} (A$)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "BRL",
                          "text": "{0}{1} (R$)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "CAD",
                          "text": "{0}{1} (C$)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "CHF",
                          "text": "{0}{1} (CHF)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "CNY",
                          "text": "{0}{1} ()"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "DKK",
                          "text": "{0}{1} (kr.)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "EUR",
                          "text": "{0}{1} ()"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "GBP",
                          "text": "{0}{1} ()"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "INR",
                          "text": "{0}{1} ()"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "JPY",
                          "text": "{0}{1} ()"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "KRW",
                          "text": "{0}{1} ()"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "NOK",
                          "text": "{0}{1} (kr)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "NZD",
                          "text": "{0}{1} (NZ$)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "RUB",
                          "text": "{0}{1} ()"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "SEK",
                          "text": "{0}{1} (kr)"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "TWD",
                          "text": "{0}{1} (NT$)"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "success",
                          "text": "{0}{1}"
                        }
                      ],
                      "customColumnWidthSetting": "18ch"
                    },
                    "tooltipFormat": {
                      "tooltip": "One of the valid billed currencies \"USD\", \"AUD\", \"BRL\", \"CAD\", \"CHF\", \"CNY\", \"DKK\", \"EUR\", \"GBP\", \"INR\", \"JPY\", \"KRW\", \"NOK\", \"NZD\", \"RUB\", \"SEK\", \"TWD\""
                    }
                  },
                  {
                    "columnMatch": "Region",
                    "formatter": 17,
                    "formatOptions": {
                      "customColumnWidthSetting": "20ch"
                    },
                    "tooltipFormat": {
                      "tooltip": "Azure Region"
                    }
                  },
                  {
                    "columnMatch": "IsData",
                    "formatter": 18,
                    "formatOptions": {
                      "thresholdsOptions": "icons",
                      "thresholdsGrid": [
                        {
                          "operator": "==",
                          "thresholdValue": "false",
                          "representation": "2",
                          "text": "False"
                        },
                        {
                          "operator": "==",
                          "thresholdValue": "true",
                          "representation": "success",
                          "text": "True"
                        },
                        {
                          "operator": "Default",
                          "thresholdValue": null,
                          "representation": "unknown",
                          "text": "{0}{1}"
                        }
                      ]
                    }
                  },
                  {
                    "columnMatch": "Url",
                    "formatter": 7,
                    "formatOptions": {
                      "linkTarget": "Url",
                      "linkIsContextBlade": false,
                      "customColumnWidthSetting": "50%"
                    }
                  },
                  {
                    "columnMatch": "Repository",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "110ch"
                    }
                  },
                  {
                    "columnMatch": "Service",
                    "formatter": 0,
                    "formatOptions": {
                      "customColumnWidthSetting": "19ch"
                    }
                  }
                ]
              }
            },
            "name": "query - Unified - Troubleshooting - URL Validation"
          },
          {
            "type": 1,
            "content": {
              "json": "# Azure Monitor Data\r\n\r\nThis should show the data from the URL above. This verifies the data is successfully imported using the following ExternalData query:\r\n\r\n```{AzureMonitorPrices}```\r\n\r\n> If the results shows a warning message, this may suggests that the external data query has not been loaded as the url is incorrect or the file is inaccessible. ",
              "style": "info"
            },
            "name": "text - Unified - Troubleshooting - External Data Help - Copy"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{AzureMonitorPrices}",
              "size": 0,
              "title": "Azure Pricing Monitor Data for Region: {WorkspaceLocation}, Currency Code: {CurrencyCode}",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TimeGenerated",
                    "formatter": 6,
                    "dateFormat": {
                      "showUtcTime": null,
                      "formatName": "shortDateTimePattern"
                    }
                  },
                  {
                    "columnMatch": "EffectiveStartDate",
                    "formatter": 6,
                    "dateFormat": {
                      "formatName": "shortDateTimePattern"
                    }
                  }
                ]
              }
            },
            "name": "query - Troubleshooting - Azure Monitor Results"
          },
          {
            "type": 1,
            "content": {
              "json": "# Microsoft Sentinel Data\r\nThis should show the data from the URL above. This verifies the data is successfully imported using the following ExternalData query:\r\n\r\n```{SentinelPrices}```\r\n\r\n> If the results shows a warning message, this may suggests that the external data query has not been loaded as the url is incorrect or the file is inaccessible. ",
              "style": "info"
            },
            "name": "text - Unified - Troubleshooting - External Data Help"
          },
          {
            "type": 3,
            "content": {
              "version": "KqlItem/1.0",
              "query": "{SentinelPrices}",
              "size": 0,
              "title": "Sentinel Pricing Data for Region: {WorkspaceLocation}, Currency Code: {CurrencyCode}",
              "timeContextFromParameter": "TimeRange",
              "queryType": 0,
              "resourceType": "microsoft.operationalinsights/workspaces",
              "crossComponentResources": [
                "{Workspace}"
              ],
              "gridSettings": {
                "formatters": [
                  {
                    "columnMatch": "TimeGenerated",
                    "formatter": 6,
                    "dateFormat": {
                      "showUtcTime": null,
                      "formatName": "shortDateTimePattern"
                    }
                  },
                  {
                    "columnMatch": "EffectiveStartDate",
                    "formatter": 6,
                    "dateFormat": {
                      "formatName": "shortDateTimePattern"
                    }
                  }
                ]
              }
            },
            "name": "query - Classic - Troubleshooting - External Data Sentinel"
          }
        ]
      },
      "name": "group - Main Page - Troubleshooting"
    }
  ],
  "fallbackResourceIds": [
    "azure monitor"
  ],
  "$schema": "https://github.com/Microsoft/Application-Insights-Workbooks/blob/master/schema/workbook.json"
}