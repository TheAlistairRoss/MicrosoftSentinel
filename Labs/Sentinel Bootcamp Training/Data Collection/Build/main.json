{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.24.24.22086",
      "templateHash": "11464593483642194390"
    }
  },
  "parameters": {
    "adminPasswordOrSSHKey": {
      "type": "securestring",
      "metadata": {
        "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "workshopadmin"
    },
    "authenticationType": {
      "type": "string",
      "defaultValue": "password",
      "allowedValues": [
        "sshPublicKey",
        "password"
      ],
      "metadata": {
        "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
      }
    },
    "basename": {
      "type": "string",
      "defaultValue": "sentinel-bootcamp",
      "metadata": {
        "description": "Resources Name Prefix. This will be used to name most of the resources and the resource group"
      }
    },
    "datetime": {
      "type": "securestring",
      "defaultValue": "[utcNow()]"
    },
    "deployAMPLS": {
      "type": "bool",
      "defaultValue": true
    },
    "deployBastion": {
      "type": "bool",
      "defaultValue": true
    },
    "deployDataCollectionRule": {
      "type": "bool",
      "defaultValue": true
    },
    "deployLinuxLogForwarder": {
      "type": "bool",
      "defaultValue": true
    },
    "deployLinuxLogSource": {
      "type": "bool",
      "defaultValue": true
    },
    "deployLogForwarderPolicies": {
      "type": "bool",
      "defaultValue": false
    },
    "deployNetworking": {
      "type": "bool",
      "defaultValue": true
    },
    "deploySentinel": {
      "type": "bool",
      "defaultValue": true
    },
    "location": {
      "type": "string",
      "defaultValue": "uksouth",
      "metadata": {
        "description": "Azure Region"
      }
    },
    "vnetAddressIpV4Id": {
      "type": "string",
      "defaultValue": "10.0.0.0",
      "minLength": 7,
      "maxLength": 13,
      "metadata": {
        "description": "Start of the Ip Address range for the Vnet. It must end with a .0 as this is using a /24 subnet mask (e.g. 10.0.0.0)"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": "[deployment().properties.templateLink.uri]",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
      }
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
      }
    }
  },
  "variables": {
    "replaceUriSpaces": "[replace(parameters('_artifactsLocation'), ' ', '%20')]",
    "artifactsLocation": "[format('{0}{1}', variables('replaceUriSpaces'), parameters('_artifactsLocationSasToken'))]",
    "vnetName": "[format('{0}-vnet', parameters('basename'))]",
    "azureBastionSubnetName": "AzureBastionSubnet",
    "logSourceSubnetName": "[format('{0}-LogSource-Subnet', parameters('basename'))]",
    "logForwarderSubnetName": "[format('{0}-LogForwarder-Subnet', parameters('basename'))]",
    "privateEndpointSubnetName": "[format('{0}-AMPLS-Subnet', parameters('basename'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2023-07-01",
      "name": "[format('{0}-rg', parameters('basename'))]",
      "location": "[parameters('location')]"
    },
    {
      "condition": "[parameters('deployNetworking')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Networking', parameters('datetime'), parameters('basename'))]",
      "resourceGroup": "[format('{0}-rg', parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logForwarderSubnetName": {
            "value": "[variables('logForwarderSubnetName')]"
          },
          "logSourceSubnetName": {
            "value": "[variables('logSourceSubnetName')]"
          },
          "privateEndpointSubnetName": {
            "value": "[variables('privateEndpointSubnetName')]"
          },
          "vnetAddressIpV4Id": {
            "value": "[parameters('vnetAddressIpV4Id')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "15269972360411106507"
            }
          },
          "parameters": {
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-bootcamp",
              "metadata": {
                "description": "Resources Name Prefix. This will be used to name most of the resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "logForwarderSubnetName": {
              "type": "string",
              "defaultValue": "logForwarderSubnet",
              "metadata": {
                "description": "Name for the Log Forwarder Subnet"
              }
            },
            "logSourceSubnetName": {
              "type": "string",
              "defaultValue": "logSourceSubnet",
              "metadata": {
                "description": "Name for the Log Source Subnet"
              }
            },
            "privateEndpointSubnetName": {
              "type": "string",
              "defaultValue": "privateEndpointSubnet",
              "metadata": {
                "description": "Name for the Private Endpoint Subnet"
              }
            },
            "vnetAddressIpV4Id": {
              "type": "string",
              "defaultValue": "10.0.0.0",
              "metadata": {
                "description": "Start of the Ip Address range for the Vnet. It must end with a .0 as this is using a /24 subnet mask (e.g. 10.0.0.0)"
              }
            },
            "vnetName": {
              "type": "string",
              "defaultValue": "[format('{0}-vnet', parameters('basename'))]",
              "metadata": {
                "description": "Name for the virtual network"
              }
            }
          },
          "variables": {
            "bastionSubnetNSGName": "[format('{0}-AzureBastionSubnet-nsg', parameters('basename'))]",
            "logSourceSubnetNSGName": "[format('{0}-{1}-nsg', parameters('basename'), parameters('logSourceSubnetName'))]",
            "logForwarderSubnetNSGName": "[format('{0}-{1}-nsg', parameters('basename'), parameters('logForwarderSubnetName'))]",
            "privateEndpointSubnetNSGName": "[format('{0}-{1}-nsg', parameters('basename'), parameters('privateEndpointSubnetName'))]",
            "vnetAddressIPv4": "[substring(parameters('vnetAddressIpV4Id'), 0, lastIndexOf(parameters('vnetAddressIpV4Id'), '.'))]",
            "vnetConfig": {
              "addressSpacePrefix": "[format('{0}.0/24', variables('vnetAddressIPv4'))]",
              "subnets": {
                "azureBastionSubnet": {
                  "name": "AzureBastionSubnet",
                  "addressPrefix": "[format('{0}.0/26', variables('vnetAddressIPv4'))]"
                },
                "logSourceSubnet": {
                  "name": "[parameters('logSourceSubnetName')]",
                  "addressPrefix": "[format('{0}.64/27', variables('vnetAddressIPv4'))]"
                },
                "logForwarderSubnet": {
                  "name": "[parameters('logForwarderSubnetName')]",
                  "addressPrefix": "[format('{0}.96/27', variables('vnetAddressIPv4'))]"
                },
                "privateEndpointSubnet": {
                  "name": "[parameters('privateEndpointSubnetName')]",
                  "addressPrefix": "[format('{0}.128/27', variables('vnetAddressIPv4'))]"
                }
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2022-07-01",
              "name": "[variables('bastionSubnetNSGName')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowHttpsInBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "Internet",
                      "destinationPortRange": "443",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowGatewayManagerInBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationPortRange": "443",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowLoadBalancerInBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationPortRange": "443",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowBastionHostCommunicationInBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationPortRanges": [
                        "8080",
                        "5701"
                      ],
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 130,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "DenyAllInBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 1000,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowSshRdpOutBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationPortRanges": [
                        "22",
                        "3389"
                      ],
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "AllowAzureCloudCommunicationOutBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationPortRange": "443",
                      "destinationAddressPrefix": "AzureCloud",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "AllowBastionHostCommunicationOutBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationPortRanges": [
                        "8080",
                        "5701"
                      ],
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "AllowGetSessionInformationOutBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "destinationPortRanges": [
                        "80",
                        "443"
                      ],
                      "access": "Allow",
                      "priority": 130,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "DenyAllOutBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 1000,
                      "direction": "Outbound"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-06-01",
              "name": "[variables('logForwarderSubnetNSGName')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "Allow-Syslog",
                    "properties": {
                      "protocol": "TCP",
                      "sourcePortRange": "*",
                      "destinationPortRange": "514",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 1000,
                      "direction": "Inbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  },
                  {
                    "name": "Allow-SSH",
                    "properties": {
                      "protocol": "TCP",
                      "sourcePortRange": "*",
                      "destinationPortRange": "22",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 1001,
                      "direction": "Inbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-06-01",
              "name": "[variables('logSourceSubnetNSGName')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": []
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-06-01",
              "name": "[variables('privateEndpointSubnetNSGName')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": []
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-05-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[variables('vnetConfig').addressSpacePrefix]"
                  ]
                }
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('vnetName'), variables('vnetConfig').subnets.azureBastionSubnet.name)]",
              "properties": {
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('bastionSubnetNSGName'))]"
                },
                "addressPrefix": "[variables('vnetConfig').subnets.azureBastionSubnet.addressPrefix]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('bastionSubnetNSGName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('vnetName'), variables('vnetConfig').subnets.logForwarderSubnet.name)]",
              "properties": {
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('logForwarderSubnetNSGName'))]"
                },
                "addressPrefix": "[variables('vnetConfig').subnets.logForwarderSubnet.addressPrefix]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('logForwarderSubnetNSGName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('vnetConfig').subnets.azureBastionSubnet.name)]"
              ]
            },
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('vnetName'), variables('vnetConfig').subnets.logSourceSubnet.name)]",
              "properties": {
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('logSourceSubnetNSGName'))]"
                },
                "addressPrefix": "[variables('vnetConfig').subnets.logSourceSubnet.addressPrefix]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('logSourceSubnetNSGName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('vnetConfig').subnets.logForwarderSubnet.name)]"
              ]
            },
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('vnetName'), variables('vnetConfig').subnets.privateEndpointSubnet.name)]",
              "properties": {
                "networkSecurityGroup": {
                  "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('logSourceSubnetNSGName'))]"
                },
                "addressPrefix": "[variables('vnetConfig').subnets.privateEndpointSubnet.addressPrefix]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('logSourceSubnetNSGName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]",
                "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('vnetConfig').subnets.logSourceSubnet.name)]"
              ]
            }
          ],
          "outputs": {
            "virtualNetworkId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', parameters('vnetName'))]"
            },
            "azureBastionSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('vnetConfig').subnets.azureBastionSubnet.name)]"
            },
            "logForwarderSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('vnetConfig').subnets.logForwarderSubnet.name)]"
            },
            "logSourceSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('vnetConfig').subnets.logSourceSubnet.name)]"
            },
            "privateEndpointSubnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vnetName'), variables('vnetConfig').subnets.privateEndpointSubnet.name)]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deployBastion')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Bastion', parameters('datetime'), parameters('basename'))]",
      "resourceGroup": "[format('{0}-rg', parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetResourceId": {
            "value": "[resourceId(subscription().id, subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename'))), 'Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('azureBastionSubnetName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "4900711334508116658"
            }
          },
          "parameters": {
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-bootcamp",
              "metadata": {
                "description": "Resources Name Prefix. This will be used to name most of the resources and the resource group"
              }
            },
            "subnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource Id of the Azure Bastion Subnet"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            }
          },
          "variables": {
            "bastionHostName": "[format('{0}-bastion', parameters('basename'))]",
            "publicIpAddressName": "[format('{0}-pip', variables('bastionHostName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2022-07-01",
              "name": "[variables('publicIpAddressName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/bastionHosts",
              "apiVersion": "2022-07-01",
              "name": "[variables('bastionHostName')]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "IpConf",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetResourceId')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpAddressName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpAddressName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-Networking', parameters('datetime'), parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deployAMPLS')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-AMPLS', parameters('datetime'), parameters('basename'))]",
      "resourceGroup": "[format('{0}-rg', parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetResourceId": {
            "value": "[resourceId(subscription().id, subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename'))), 'Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('privateEndpointSubnetName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "895059144587990387"
            }
          },
          "parameters": {
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-bootcamp",
              "metadata": {
                "description": "Resources Name Prefix. This will be used to name most of the resources and the resource group"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "subnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "The ResourceId of the subnet to use for the virtual machine"
              }
            }
          },
          "variables": {
            "amplsName": "[format('{0}-ampls', parameters('basename'))]",
            "amplsIngestionAccessMode": "Open",
            "amplsQueryAccessMode": "Open",
            "DNSZones": [
              "privatelink.monitor.azure.com",
              "privatelink.oms.opinsights.azure.com",
              "privatelink.ods.opinsights.azure.com",
              "privatelink.agentsvc.azure-automation.net",
              "[format('privatelink.blob.{0}', environment().suffixes.storage)]"
            ],
            "privateEndpointName": "[format('{0}-ampls-privateEndpoint', parameters('basename'))]",
            "privateEndpointNICName": "[format('{0}-nic', variables('privateEndpointName'))]",
            "virtualNetworkId": "[substring(parameters('subnetResourceId'), 0, indexOf(parameters('subnetResourceId'), '/subnets/'))]"
          },
          "resources": [
            {
              "type": "microsoft.insights/privateLinkScopes",
              "apiVersion": "2021-07-01-preview",
              "name": "[variables('amplsName')]",
              "location": "global",
              "properties": {
                "accessModeSettings": {
                  "queryAccessMode": "[variables('amplsQueryAccessMode')]",
                  "ingestionAccessMode": "[variables('amplsIngestionAccessMode')]",
                  "exclusions": []
                }
              }
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2021-05-01",
              "name": "[variables('privateEndpointName')]",
              "location": "[parameters('location')]",
              "tags": {},
              "properties": {
                "subnet": {
                  "id": "[parameters('subnetResourceId')]"
                },
                "customNetworkInterfaceName": "[variables('privateEndpointNICName')]",
                "privateLinkServiceConnections": [
                  {
                    "name": "[variables('privateEndpointName')]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('microsoft.insights/privateLinkScopes', variables('amplsName'))]",
                      "groupIds": [
                        "azuremonitor"
                      ]
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('microsoft.insights/privateLinkScopes', variables('amplsName'))]"
              ]
            },
            {
              "copy": {
                "name": "privateDNSZones",
                "count": "[length(variables('DNSZones'))]"
              },
              "type": "Microsoft.Network/privateDnsZones",
              "apiVersion": "2018-09-01",
              "name": "[variables('DNSZones')[copyIndex()]]",
              "location": "global",
              "tags": {},
              "properties": {}
            },
            {
              "copy": {
                "name": "privateDNSZonesVirtualNetworkLinks",
                "count": "[length(variables('DNSZones'))]"
              },
              "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
              "apiVersion": "2018-09-01",
              "name": "[format('{0}/{1}', variables('DNSZones')[copyIndex()], uniqueString(variables('virtualNetworkId')))]",
              "location": "global",
              "properties": {
                "virtualNetwork": {
                  "id": "[variables('virtualNetworkId')]"
                },
                "registrationEnabled": false
              },
              "dependsOn": [
                "privateDNSZones"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2021-05-01",
              "name": "[format('{0}/{1}', variables('privateEndpointName'), 'default')]",
              "properties": {
                "copy": [
                  {
                    "name": "privateDnsZoneConfigs",
                    "count": "[length(variables('DNSZones'))]",
                    "input": {
                      "name": "[variables('DNSZones')[copyIndex('privateDnsZoneConfigs')]]",
                      "properties": {
                        "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', variables('DNSZones')[copyIndex('privateDnsZoneConfigs')])]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "privateDNSZones",
                "[resourceId('Microsoft.Network/privateEndpoints', variables('privateEndpointName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-Networking', parameters('datetime'), parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Wksp', parameters('datetime'), parameters('basename'))]",
      "resourceGroup": "[format('{0}-rg', parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "2197235032349388016"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-bootcamp"
            }
          },
          "variables": {
            "workspaceName": "[format('{0}-wksp', parameters('basename'))]"
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[variables('workspaceName')]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.OperationsManagement/solutions",
              "apiVersion": "2015-11-01-preview",
              "name": "[format('SecurityInsights({0})', variables('workspaceName'))]",
              "location": "[parameters('location')]",
              "plan": {
                "name": "[format('SecurityInsights({0})', variables('workspaceName'))]",
                "promotionCode": "",
                "product": "OMSGallery/SecurityInsights",
                "publisher": "Microsoft"
              },
              "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('workspaceName'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deployDataCollectionRule')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-DCR', parameters('datetime'), parameters('basename'))]",
      "resourceGroup": "[format('{0}-rg', parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-Wksp', parameters('datetime'), parameters('basename'))), '2022-09-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "17857636865629203484"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "workspaceResourceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace Resource Id"
              }
            },
            "basename": {
              "type": "string",
              "defaultValue": "sent-adv-logging-workshop",
              "minLength": 5,
              "maxLength": 40
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2022-06-01",
              "name": "[format('{0}-syslog-dcr', parameters('basename'))]",
              "location": "[parameters('location')]",
              "kind": "Linux",
              "properties": {
                "dataSources": {
                  "syslog": [
                    {
                      "streams": [
                        "Microsoft-Syslog"
                      ],
                      "facilityNames": [
                        "user",
                        "auth",
                        "authpriv"
                      ],
                      "logLevels": [
                        "Info",
                        "Notice",
                        "Warning",
                        "Error",
                        "Critical",
                        "Alert",
                        "Emergency"
                      ],
                      "name": "sysLogsDataSource"
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[parameters('workspaceResourceId')]",
                      "name": "DataCollectionEvent"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Microsoft-Syslog"
                    ],
                    "destinations": [
                      "DataCollectionEvent"
                    ]
                  }
                ]
              }
            }
          ],
          "outputs": {
            "syslogDcrResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('{0}-syslog-dcr', parameters('basename')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-Wksp', parameters('datetime'), parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deployLinuxLogSource')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Log-Source', parameters('datetime'), parameters('basename'))]",
      "resourceGroup": "[format('{0}-rg', parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminPasswordOrKey": {
            "value": "[parameters('adminPasswordOrSSHKey')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "osVersion": {
            "value": "Ubuntu-2004"
          },
          "securityType": {
            "value": "TrustedLaunch"
          },
          "subnetResourceId": {
            "value": "[resourceId(subscription().id, subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename'))), 'Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('logSourceSubnetName'))]"
          },
          "vmName": {
            "value": "[format('{0}-LogSource', parameters('basename'))]"
          },
          "vmSize": {
            "value": "Standard_D2s_v3"
          },
          "_artifactsLocation": {
            "value": "[variables('artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "10533049095953784968"
            }
          },
          "parameters": {
            "adminPasswordOrKey": {
              "type": "securestring",
              "metadata": {
                "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
              }
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "Username for the Virtual Machine."
              }
            },
            "authenticationType": {
              "type": "string",
              "defaultValue": "password",
              "allowedValues": [
                "sshPublicKey",
                "password"
              ],
              "metadata": {
                "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
              }
            },
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-bootcamp",
              "metadata": {
                "description": "Resources Name Prefix"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "osVersion": {
              "type": "string",
              "defaultValue": "Ubuntu-2004",
              "allowedValues": [
                "Ubuntu-1804",
                "Ubuntu-2004",
                "Ubuntu-2204"
              ],
              "metadata": {
                "description": "The version of the Ubuntu to use for the Virtual Machine."
              }
            },
            "securityType": {
              "type": "string",
              "defaultValue": "TrustedLaunch",
              "allowedValues": [
                "Standard",
                "TrustedLaunch"
              ],
              "metadata": {
                "description": "Security Type of the Virtual Machine."
              }
            },
            "subnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "The Resource Id of the subnet to use for the virtual machine"
              }
            },
            "vmName": {
              "type": "string",
              "defaultValue": "LinuxLogSource",
              "metadata": {
                "description": "The name of your Virtual Machine."
              }
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_D2s_v3",
              "metadata": {
                "description": "The size of the VM"
              }
            },
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]",
              "metadata": {
                "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
              }
            },
            "_artifactsLocationSasToken": {
              "type": "securestring",
              "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "scriptFilesUris",
                "count": "[length(variables('scriptFiles'))]",
                "input": "[uri(parameters('_artifactsLocation'), format('{0}{1}', variables('scriptFiles')[copyIndex('scriptFilesUris')], parameters('_artifactsLocationSasToken')))]"
              }
            ],
            "customScriptExtension": {
              "name": "CustomScript",
              "publisher": "Microsoft.Azure.Extensions",
              "typeHandlerVersion": "2.1",
              "fileUris": "[variables('scriptFilesUris')]",
              "commandToExecute": "./config.sh"
            },
            "imageReference": {
              "Ubuntu-1804": {
                "publisher": "Canonical",
                "offer": "UbuntuServer",
                "sku": "18_04-lts-gen2",
                "version": "latest"
              },
              "Ubuntu-2004": {
                "publisher": "Canonical",
                "offer": "0001-com-ubuntu-server-focal",
                "sku": "20_04-lts-gen2",
                "version": "latest"
              },
              "Ubuntu-2204": {
                "publisher": "Canonical",
                "offer": "0001-com-ubuntu-server-jammy",
                "sku": "22_04-lts-gen2",
                "version": "latest"
              }
            },
            "linuxConfiguration": {
              "disablePasswordAuthentication": true,
              "ssh": {
                "publicKeys": [
                  {
                    "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                    "keyData": "[parameters('adminPasswordOrKey')]"
                  }
                ]
              }
            },
            "osDiskType": "Standard_LRS",
            "scriptFiles": [
              "LinuxLogSource/Config/config.sh",
              "LinuxLogSource/Config/rsyslog-50-default.conf"
            ],
            "securityProfileJson": {
              "uefiSettings": {
                "secureBootEnabled": true,
                "vTpmEnabled": true
              },
              "securityType": "[parameters('securityType')]"
            },
            "storageAccountName": "[toLower(replace(format('{0}diag', parameters('basename')), '-', ''))]",
            "trustedLaunchExtension": {
              "extensionName": "GuestAttestation",
              "extensionPublisher": "Microsoft.Azure.Security.LinuxAttestation",
              "extensionVersion": "1.0",
              "maaTenantName": "GuestAttestation",
              "maaEndpoint": "[substring('emptystring', 0, 0)]"
            },
            "vmNetworkInterfaceName": "[format('{0}NetInt', parameters('vmName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-09-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "supportsHttpsTrafficOnly": true
              }
            },
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-05-01",
              "name": "[variables('vmNetworkInterfaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetResourceId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2021-11-01",
              "name": "[parameters('vmName')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "storageProfile": {
                  "osDisk": {
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "[variables('osDiskType')]"
                    }
                  },
                  "imageReference": "[variables('imageReference')[parameters('osVersion')]]"
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vmNetworkInterfaceName'))]"
                    }
                  ]
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": true,
                    "storageUri": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2022-09-01').primaryEndpoints.blob]"
                  }
                },
                "osProfile": {
                  "computerName": "[parameters('vmName')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPasswordOrKey')]",
                  "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                },
                "securityProfile": "[if(equals(parameters('securityType'), 'TrustedLaunch'), variables('securityProfileJson'), null())]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]",
                "[resourceId('Microsoft.Network/networkInterfaces', variables('vmNetworkInterfaceName'))]"
              ]
            },
            {
              "condition": "[and(equals(parameters('securityType'), 'TrustedLaunch'), and(equals(variables('securityProfileJson').uefiSettings.secureBootEnabled, true()), equals(variables('securityProfileJson').uefiSettings.vTpmEnabled, true())))]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('vmName'), variables('trustedLaunchExtension').extensionName)]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "[variables('trustedLaunchExtension').extensionPublisher]",
                "type": "[variables('trustedLaunchExtension').extensionName]",
                "typeHandlerVersion": "[variables('trustedLaunchExtension').extensionVersion]",
                "autoUpgradeMinorVersion": true,
                "enableAutomaticUpgrade": true,
                "settings": {
                  "AttestationConfig": {
                    "MaaSettings": {
                      "maaEndpoint": "[variables('trustedLaunchExtension').maaEndpoint]",
                      "maaTenantName": "[variables('trustedLaunchExtension').maaTenantName]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('vmName'), variables('customScriptExtension').name)]",
              "location": "[parameters('location')]",
              "properties": {
                "publisher": "[variables('customScriptExtension').publisher]",
                "type": "[variables('customScriptExtension').name]",
                "typeHandlerVersion": "[variables('customScriptExtension').typeHandlerVersion]",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "commandToExecute": "[variables('customScriptExtension').commandToExecute]",
                  "fileUris": "[variables('customScriptExtension').fileUris]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-Networking', parameters('datetime'), parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deployLinuxLogForwarder')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Log-Forwarder', parameters('datetime'), parameters('basename'))]",
      "resourceGroup": "[format('{0}-rg', parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminPasswordOrKey": {
            "value": "[parameters('adminPasswordOrSSHKey')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "autoscaleMin": {
            "value": 1
          },
          "autoscaleMax": {
            "value": 3
          },
          "basename": {
            "value": "[parameters('basename')]"
          },
          "dataCollectionRuleResourceIds": {
            "value": [
              "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-DCR', parameters('datetime'), parameters('basename'))), '2022-09-01').outputs.syslogDcrResourceId.value]"
            ]
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "OSVersion": {
            "value": "Ubuntu-2004"
          },
          "securityType": {
            "value": "TrustedLaunch"
          },
          "subnetResourceId": {
            "value": "[resourceId(subscription().id, subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename'))), 'Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('logForwarderSubnetName'))]"
          },
          "vmssName": {
            "value": "[format('{0}-Log-Forwarder', parameters('basename'))]"
          },
          "vmssSize": {
            "value": "Standard_D2s_v3"
          },
          "_artifactsLocation": {
            "value": "[variables('artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "15071892415835648632"
            }
          },
          "parameters": {
            "adminPasswordOrKey": {
              "type": "securestring",
              "metadata": {
                "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
              }
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "Username for the Virtual Machine."
              }
            },
            "authenticationType": {
              "type": "string",
              "defaultValue": "password",
              "allowedValues": [
                "sshPublicKey",
                "password"
              ],
              "metadata": {
                "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
              }
            },
            "autoscaleMax": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "The maximum number of VMs in the scale set"
              }
            },
            "autoscaleMin": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "The minimum number of VMs in the scale set"
              }
            },
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-bootcamp",
              "metadata": {
                "description": "Resources Name Prefix"
              }
            },
            "dataCollectionRuleResourceIds": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "The data collection rule resource ids to associate with the VM"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "OSVersion": {
              "type": "string",
              "defaultValue": "Ubuntu-2004",
              "allowedValues": [
                "Ubuntu-1804",
                "Ubuntu-2004",
                "Ubuntu-2204"
              ],
              "metadata": {
                "description": "The version of the Ubuntu to use for the Virtual Machine Scale Set"
              }
            },
            "securityType": {
              "type": "string",
              "defaultValue": "TrustedLaunch",
              "allowedValues": [
                "Standard",
                "TrustedLaunch"
              ],
              "metadata": {
                "description": "Security Type of the Virtual Machine."
              }
            },
            "subnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "The ResourceId of the subnet to use for the virtual machine"
              }
            },
            "vmssName": {
              "type": "string",
              "defaultValue": "LinuxLogForwarder",
              "metadata": {
                "description": "The name of your Virtual Machine."
              }
            },
            "vmssSize": {
              "type": "string",
              "defaultValue": "Standard_D2s_v3",
              "metadata": {
                "description": "The size of the VM"
              }
            },
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]",
              "metadata": {
                "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
              }
            },
            "_artifactsLocationSasToken": {
              "type": "securestring",
              "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "scriptFilesUris",
                "count": "[length(variables('scriptFiles'))]",
                "input": "[uri(parameters('_artifactsLocation'), format('{0}{1}', variables('scriptFiles')[copyIndex('scriptFilesUris')], parameters('_artifactsLocationSasToken')))]"
              }
            ],
            "autoscaleName": "[format('{0}-autoscale', parameters('basename'))]",
            "customScriptExtension": {
              "name": "CustomScript",
              "publisher": "Microsoft.Azure.Extensions",
              "typeHandlerVersion": "2.1",
              "fileUris": "[variables('scriptFilesUris')]",
              "commandToExecute": "./config.sh"
            },
            "imageReference": {
              "Ubuntu-1804": {
                "publisher": "Canonical",
                "offer": "UbuntuServer",
                "sku": "18_04-lts-gen2",
                "version": "latest"
              },
              "Ubuntu-2004": {
                "publisher": "Canonical",
                "offer": "0001-com-ubuntu-server-focal",
                "sku": "20_04-lts-gen2",
                "version": "latest"
              },
              "Ubuntu-2204": {
                "publisher": "Canonical",
                "offer": "0001-com-ubuntu-server-jammy",
                "sku": "22_04-lts-gen2",
                "version": "latest"
              }
            },
            "linuxPasswordConfiguration": {
              "disablePasswordAuthentication": false,
              "provisionVMAgent": true
            },
            "linuxSSHConfiguration": {
              "disablePasswordAuthentication": true,
              "provisionVMAgent": true,
              "ssh": {
                "publicKeys": [
                  {
                    "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                    "keyData": "[parameters('adminPasswordOrKey')]"
                  }
                ]
              }
            },
            "loadbalancerName": "[format('{0}-lb', parameters('basename'))]",
            "maxPortRange": "[if(lessOrEquals(parameters('autoscaleMax'), 9), '5000', '500')]",
            "scriptFiles": [
              "LinuxLogForwarder/Config/config.sh",
              "LinuxLogForwarder/Config/rsyslog-50-default.conf"
            ],
            "securityProfileJson": {
              "uefiSettings": {
                "secureBootEnabled": true,
                "vTpmEnabled": true
              },
              "securityType": "[parameters('securityType')]"
            },
            "storageAccountName": "[toLower(replace(format('{0}diag', parameters('basename')), '-', ''))]",
            "trustedLaunchExtension": {
              "extensionName": "GuestAttestation",
              "extensionPublisher": "Microsoft.Azure.Security.LinuxAttestation",
              "extensionVersion": "1.0",
              "maaTenantName": "GuestAttestation",
              "maaEndpoint": "[substring('emptystring', 0, 0)]"
            },
            "vmssNICName": "[format('{0}-nic', parameters('vmssName'))]",
            "vmssOSdiskType": "Standard_LRS"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-09-01",
              "name": "[variables('storageAccountName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard_LRS"
              },
              "kind": "StorageV2",
              "properties": {
                "supportsHttpsTrafficOnly": true
              }
            },
            {
              "type": "Microsoft.Network/loadBalancers",
              "apiVersion": "2023-06-01",
              "name": "[variables('loadbalancerName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard",
                "tier": "Regional"
              },
              "properties": {
                "frontendIPConfigurations": [
                  {
                    "name": "LoadBalancerFrontEnd",
                    "properties": {
                      "privateIPAddressVersion": "IPv4",
                      "privateIPAllocationMethod": "Dynamic",
                      "privateIPAddress": "[format('{0}.100', substring(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', split(parameters('subnetResourceId'), '/')[8], split(parameters('subnetResourceId'), '/')[10]), '/')[0], split(format('{0}/{1}', split(parameters('subnetResourceId'), '/')[8], split(parameters('subnetResourceId'), '/')[10]), '/')[1]), '2023-05-01').addressPrefix, 0, lastIndexOf(reference(resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', split(parameters('subnetResourceId'), '/')[8], split(parameters('subnetResourceId'), '/')[10]), '/')[0], split(format('{0}/{1}', split(parameters('subnetResourceId'), '/')[8], split(parameters('subnetResourceId'), '/')[10]), '/')[1]), '2023-05-01').addressPrefix, '.')))]",
                      "subnet": {
                        "id": "[parameters('subnetResourceId')]"
                      }
                    }
                  }
                ],
                "backendAddressPools": [
                  {
                    "name": "bepool",
                    "properties": {}
                  }
                ],
                "loadBalancingRules": [
                  {
                    "name": "LBSyslogTCPRule",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIpConfigurations', variables('loadbalancerName'), 'LoadBalancerFrontend')]"
                      },
                      "frontendPort": 514,
                      "backendPort": 514,
                      "enableFloatingIP": false,
                      "idleTimeoutInMinutes": 5,
                      "protocol": "TCP",
                      "enableTcpReset": false,
                      "loadDistribution": "Default",
                      "disableOutboundSnat": false,
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadbalancerName'), 'bepool')]"
                      },
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadbalancerName'), 'tcpProbe')]"
                      }
                    }
                  },
                  {
                    "name": "LBSyslogUDPRule",
                    "properties": {
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIpConfigurations', variables('loadbalancerName'), 'LoadBalancerFrontend')]"
                      },
                      "frontendPort": 514,
                      "backendPort": 514,
                      "enableFloatingIP": false,
                      "idleTimeoutInMinutes": 5,
                      "protocol": "Udp",
                      "enableTcpReset": false,
                      "loadDistribution": "Default",
                      "disableOutboundSnat": false,
                      "backendAddressPool": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/backendAddressPools', variables('loadbalancerName'), 'bepool')]"
                      },
                      "probe": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/probes', variables('loadbalancerName'), 'tcpProbe')]"
                      }
                    }
                  }
                ],
                "probes": [
                  {
                    "name": "tcpProbe",
                    "properties": {
                      "protocol": "Tcp",
                      "port": 514,
                      "intervalInSeconds": 5,
                      "numberOfProbes": 2
                    }
                  }
                ],
                "inboundNatRules": [],
                "outboundRules": [],
                "inboundNatPools": [
                  {
                    "name": "natPool",
                    "properties": {
                      "frontendPortRangeStart": 50000,
                      "frontendPortRangeEnd": "[int(format('{0}{1}', variables('maxPortRange'), parameters('autoscaleMax')))]",
                      "backendPort": 22,
                      "protocol": "Tcp",
                      "idleTimeoutInMinutes": 5,
                      "enableFloatingIP": false,
                      "enableTcpReset": false,
                      "frontendIPConfiguration": {
                        "id": "[resourceId('Microsoft.Network/loadBalancers/frontendIpConfigurations', variables('loadbalancerName'), 'LoadBalancerFrontend')]"
                      }
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets",
              "apiVersion": "2023-09-01",
              "name": "[parameters('vmssName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "[parameters('vmssSize')]",
                "tier": "Standard",
                "capacity": "[parameters('autoscaleMin')]"
              },
              "properties": {
                "singlePlacementGroup": true,
                "upgradePolicy": {
                  "mode": "Rolling"
                },
                "virtualMachineProfile": {
                  "osProfile": {
                    "computerNamePrefix": "[parameters('basename')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPasswordOrKey')]",
                    "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), variables('linuxPasswordConfiguration'), variables('linuxSSHConfiguration'))]",
                    "secrets": []
                  },
                  "storageProfile": {
                    "osDisk": {
                      "createOption": "FromImage",
                      "caching": "ReadWrite",
                      "managedDisk": {
                        "storageAccountType": "[variables('vmssOSdiskType')]"
                      },
                      "diskSizeGB": 32
                    },
                    "imageReference": "[variables('imageReference')[parameters('OSVersion')]]"
                  },
                  "networkProfile": {
                    "networkInterfaceConfigurations": [
                      {
                        "name": "[variables('vmssNICName')]",
                        "properties": {
                          "primary": true,
                          "enableAcceleratedNetworking": false,
                          "dnsSettings": {
                            "dnsServers": []
                          },
                          "enableIPForwarding": false,
                          "ipConfigurations": [
                            {
                              "name": "[format('{0}-ipConfig', parameters('basename'))]",
                              "properties": {
                                "subnet": {
                                  "id": "[parameters('subnetResourceId')]"
                                },
                                "privateIPAddressVersion": "IPv4",
                                "loadBalancerBackendAddressPools": [
                                  {
                                    "id": "[format('{0}/backendAddressPools/bepool', resourceId('Microsoft.Network/loadBalancers', variables('loadbalancerName')))]"
                                  }
                                ],
                                "loadBalancerInboundNatPools": [
                                  {
                                    "id": "[format('{0}/inboundNatPools/natPool', resourceId('Microsoft.Network/loadBalancers', variables('loadbalancerName')))]"
                                  }
                                ]
                              }
                            }
                          ]
                        }
                      }
                    ]
                  },
                  "diagnosticsProfile": {
                    "bootDiagnostics": {
                      "enabled": true,
                      "storageUri": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName')), '2022-09-01').primaryEndpoints.blob]"
                    }
                  },
                  "priority": "Regular"
                },
                "overprovision": true,
                "doNotRunExtensionsOnOverprovisionedVMs": false,
                "platformFaultDomainCount": 5
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/loadBalancers', variables('loadbalancerName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', variables('storageAccountName'))]"
              ]
            },
            {
              "type": "Microsoft.Insights/autoscalesettings",
              "apiVersion": "2022-10-01",
              "name": "[variables('autoscaleName')]",
              "location": "[parameters('location')]",
              "properties": {
                "profiles": [
                  {
                    "name": "CPU Scaling",
                    "capacity": {
                      "minimum": "[format('{0}', parameters('autoscaleMin'))]",
                      "maximum": "[format('{0}', parameters('autoscaleMax'))]",
                      "default": "[format('{0}', parameters('autoscaleMin'))]"
                    },
                    "rules": [
                      {
                        "metricTrigger": {
                          "metricName": "Percentage CPU",
                          "metricNamespace": "",
                          "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]",
                          "timeGrain": "PT1M",
                          "statistic": "Average",
                          "timeWindow": "PT5M",
                          "timeAggregation": "Average",
                          "operator": "GreaterThan",
                          "threshold": 75,
                          "dimensions": [],
                          "dividePerInstance": false
                        },
                        "scaleAction": {
                          "direction": "Increase",
                          "type": "ChangeCount",
                          "value": "1",
                          "cooldown": "PT1M"
                        }
                      },
                      {
                        "metricTrigger": {
                          "metricName": "Percentage CPU",
                          "metricNamespace": "",
                          "metricResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]",
                          "timeGrain": "PT1M",
                          "statistic": "Average",
                          "timeWindow": "PT5M",
                          "timeAggregation": "Average",
                          "operator": "LessThan",
                          "threshold": 25,
                          "dimensions": [],
                          "dividePerInstance": false
                        },
                        "scaleAction": {
                          "direction": "Decrease",
                          "type": "ChangeCount",
                          "value": "1",
                          "cooldown": "PT1M"
                        }
                      }
                    ]
                  }
                ],
                "enabled": true,
                "name": "[format('{0}-autoscale', parameters('basename'))]",
                "targetResourceUri": "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('dataCollectionRuleResourceIds')))]",
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', parameters('vmssName'), 'AzureMonitorLinuxAgent')]",
              "properties": {
                "autoUpgradeMinorVersion": true,
                "publisher": "Microsoft.Azure.Monitor",
                "type": "AzureMonitorLinuxAgent",
                "typeHandlerVersion": "1.0"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]"
              ]
            },
            {
              "condition": "[and(equals(parameters('securityType'), 'TrustedLaunch'), and(equals(variables('securityProfileJson').uefiSettings.secureBootEnabled, true()), equals(variables('securityProfileJson').uefiSettings.vTpmEnabled, true())))]",
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', parameters('vmssName'), variables('trustedLaunchExtension').extensionName)]",
              "properties": {
                "publisher": "[variables('trustedLaunchExtension').extensionPublisher]",
                "type": "[variables('trustedLaunchExtension').extensionName]",
                "typeHandlerVersion": "[variables('trustedLaunchExtension').extensionVersion]",
                "autoUpgradeMinorVersion": true,
                "enableAutomaticUpgrade": true,
                "settings": {
                  "AttestationConfig": {
                    "MaaSettings": {
                      "maaEndpoint": "[variables('trustedLaunchExtension').maaEndpoint]",
                      "maaTenantName": "[variables('trustedLaunchExtension').maaTenantName]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachineScaleSets/extensions",
              "apiVersion": "2023-09-01",
              "name": "[format('{0}/{1}', parameters('vmssName'), variables('customScriptExtension').name)]",
              "properties": {
                "publisher": "[variables('customScriptExtension').publisher]",
                "type": "[variables('customScriptExtension').name]",
                "typeHandlerVersion": "[variables('customScriptExtension').typeHandlerVersion]",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "commandToExecute": "[variables('customScriptExtension').commandToExecute]",
                  "fileUris": "[variables('customScriptExtension').fileUris]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]",
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets/extensions', parameters('vmssName'), 'AzureMonitorLinuxAgent')]"
              ]
            },
            {
              "copy": {
                "name": "dcrAssociation",
                "count": "[length(parameters('dataCollectionRuleResourceIds'))]"
              },
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2022-06-01",
              "scope": "[format('Microsoft.Compute/virtualMachineScaleSets/{0}', parameters('vmssName'))]",
              "name": "[format('{0}-dcrassociation)}}', uniqueString(resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName')), parameters('dataCollectionRuleResourceIds')[copyIndex()]))]",
              "properties": {
                "dataCollectionRuleId": "[parameters('dataCollectionRuleResourceIds')[copyIndex()]]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachineScaleSets', parameters('vmssName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-DCR', parameters('datetime'), parameters('basename')))]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename')))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-Networking', parameters('datetime'), parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deployLogForwarderPolicies')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-LF-Policies', parameters('datetime'), parameters('basename'))]",
      "resourceGroup": "[format('{0}-rg', parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "policyDefinitionID": {
            "value": "/providers/Microsoft.Authorization/policyDefinitions/050a90d5-7cce-483f-8f6c-0df462036dda"
          },
          "policyAssignmentName": {
            "value": "[format('{0}-Configure Log Forwarder with DCR', parameters('basename'))]"
          },
          "policyParameters": {
            "value": {
              "effect": "DeployIfNotExists",
              "listOfLinuxImageIdToInclude": [],
              "dcrResourceId": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-DCR', parameters('datetime'), parameters('basename'))), '2022-09-01').outputs.syslogDcrResourceId.value]",
              "resourceType": "Microsoft.Insights/dataCollectionEndpoints"
            }
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "9760379159494364233"
            }
          },
          "parameters": {
            "policyDefinitionID": {
              "type": "string",
              "metadata": {
                "description": "Specifies the ID of the policy definition or policy set definition being assigned."
              }
            },
            "policyAssignmentName": {
              "type": "string",
              "defaultValue": "[guid(parameters('policyDefinitionID'), resourceGroup().name)]",
              "metadata": {
                "description": "Specifies the name of the policy assignment, can be used defined or an idempotent name as the defaultValue provides."
              }
            },
            "policyParameters": {
              "type": "object",
              "defaultValue": {
                "Parameter1": "value1",
                "Parameter2": "value2"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/policyAssignments",
              "apiVersion": "2023-04-01",
              "name": "[parameters('policyAssignmentName')]",
              "properties": {
                "scope": "[resourceGroup()]",
                "policyDefinitionId": "[parameters('policyDefinitionID')]",
                "parameters": "[parameters('policyParameters')]"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, format('{0}-rg', parameters('basename'))), 'Microsoft.Resources/deployments', format('{0}-{1}-DCR', parameters('datetime'), parameters('basename')))]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', format('{0}-rg', parameters('basename')))]"
      ]
    }
  ]
}