{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.24.24.22086",
      "templateHash": "5290200725288511036"
    }
  },
  "parameters": {
    "adminPasswordOrSSHKey": {
      "type": "securestring",
      "defaultValue": "WorkshopPassword1234",
      "metadata": {
        "description": "SSH Key or password for the Virtual Machine."
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "workshopadmin",
      "metadata": {
        "description": "Username for the Virtual Machine."
      }
    },
    "authenticationType": {
      "type": "string",
      "defaultValue": "password",
      "allowedValues": [
        "sshPublicKey",
        "password"
      ],
      "metadata": {
        "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
      }
    },
    "basename": {
      "type": "string",
      "defaultValue": "sentinel-workshop",
      "minLength": 5,
      "maxLength": 40
    },
    "datetime": {
      "type": "string",
      "defaultValue": "[utcNow()]",
      "metadata": {
        "description": "Current UTC Datetime in the format YYYYMMDDhhmmss"
      }
    },
    "deployBastion": {
      "type": "bool",
      "defaultValue": true
    },
    "deployDataCollectionRule": {
      "type": "bool",
      "defaultValue": true
    },
    "deployLinuxLogSource": {
      "type": "bool",
      "defaultValue": true
    },
    "deployNetworking": {
      "type": "bool",
      "defaultValue": true
    },
    "deploySentinel": {
      "type": "bool",
      "defaultValue": true
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure Region"
      }
    },
    "vnetAddressIpV4Id": {
      "type": "string",
      "defaultValue": "10.0.0.0",
      "minLength": 7,
      "maxLength": 13,
      "metadata": {
        "description": "Start of the Ip Address range for the Vnet. It must end with a .0 as this is using a /24 subnet mask (e.g. 10.0.0.0)"
      }
    },
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": "[deployment().properties.templateLink.uri]",
      "metadata": {
        "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
      }
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
      }
    }
  },
  "variables": {
    "azureBastionSubnetName": "AzureBastionSubnet",
    "logSourceSubnetName": "[format('{0}-LogSource-Subnet', parameters('basename'))]",
    "vmName": "[format('{0}-LogSource', parameters('basename'))]",
    "vnetId": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/virtualNetworks/{2}', subscription().subscriptionId, resourceGroup().name, variables('vnetName'))]",
    "vnetName": "[format('{0}-vnet', parameters('basename'))]",
    "workspaceId": "[format('{0}/providers/Microsoft.OperationalInsights/workspaces/{1}', resourceGroup().id, variables('workspaceName'))]",
    "workspaceName": "[format('{0}-wksp', parameters('basename'))]"
  },
  "resources": [
    {
      "condition": "[parameters('deployNetworking')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Networking', parameters('datetime'), parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "logSourceSubnetName": {
            "value": "[variables('logSourceSubnetName')]"
          },
          "vnetAddressIpV4Id": {
            "value": "[parameters('vnetAddressIpV4Id')]"
          },
          "vnetName": {
            "value": "[variables('vnetName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "12416438584589517361"
            }
          },
          "parameters": {
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-workshop",
              "metadata": {
                "description": "Resources Name Prefix. This will be used to name most of the resources"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "logSourceSubnetName": {
              "type": "string",
              "defaultValue": "logSourceSubnet",
              "metadata": {
                "description": "Name for the Log Source Subnet"
              }
            },
            "vnetAddressIpV4Id": {
              "type": "string",
              "defaultValue": "10.0.0.0",
              "metadata": {
                "description": "Start of the Ip Address range for the Vnet. It must end with a .0 as this is using a /24 subnet mask (e.g. 10.0.0.0)"
              }
            },
            "vnetName": {
              "type": "string",
              "defaultValue": "[format('{0}-vnet', parameters('basename'))]",
              "metadata": {
                "description": "Name for the virtual network"
              }
            }
          },
          "variables": {
            "bastionSubnetNSGName": "[format('{0}-AzureBastionSubnet-nsg', parameters('basename'))]",
            "logSourceSubnetNSGName": "[format('{0}-{1}-nsg', parameters('basename'), parameters('logSourceSubnetName'))]",
            "vnetAddressIPv4": "[substring(parameters('vnetAddressIpV4Id'), 0, lastIndexOf(parameters('vnetAddressIpV4Id'), '.'))]",
            "vnetConfig": {
              "addressSpacePrefix": "[format('{0}.0/24', variables('vnetAddressIPv4'))]",
              "subnets": {
                "azureBastionSubnet": {
                  "name": "AzureBastionSubnet",
                  "addressPrefix": "[format('{0}.0/26', variables('vnetAddressIPv4'))]"
                },
                "logSourceSubnet": {
                  "name": "[parameters('logSourceSubnetName')]",
                  "addressPrefix": "[format('{0}.64/27', variables('vnetAddressIPv4'))]"
                }
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2022-07-01",
              "name": "[variables('bastionSubnetNSGName')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowHttpsInBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "Internet",
                      "destinationPortRange": "443",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowGatewayManagerInBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationPortRange": "443",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowLoadBalancerInBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "AzureLoadBalancer",
                      "destinationPortRange": "443",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowBastionHostCommunicationInBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationPortRanges": [
                        "8080",
                        "5701"
                      ],
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 130,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "DenyAllInBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationPortRange": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 1000,
                      "direction": "Inbound"
                    }
                  },
                  {
                    "name": "AllowSshRdpOutBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationPortRanges": [
                        "22",
                        "3389"
                      ],
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "AllowAzureCloudCommunicationOutBound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationPortRange": "443",
                      "destinationAddressPrefix": "AzureCloud",
                      "access": "Allow",
                      "priority": 110,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "AllowBastionHostCommunicationOutBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "VirtualNetwork",
                      "destinationPortRanges": [
                        "8080",
                        "5701"
                      ],
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 120,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "AllowGetSessionInformationOutBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "Internet",
                      "destinationPortRanges": [
                        "80",
                        "443"
                      ],
                      "access": "Allow",
                      "priority": 130,
                      "direction": "Outbound"
                    }
                  },
                  {
                    "name": "DenyAllOutBound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "destinationPortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "*",
                      "access": "Deny",
                      "priority": 1000,
                      "direction": "Outbound"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2023-06-01",
              "name": "[variables('logSourceSubnetNSGName')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": []
              }
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2023-05-01",
              "name": "[parameters('vnetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[variables('vnetConfig').addressSpacePrefix]"
                  ]
                },
                "subnets": [
                  {
                    "name": "[variables('vnetConfig').subnets.azureBastionSubnet.name]",
                    "properties": {
                      "addressPrefix": "[variables('vnetConfig').subnets.azureBastionSubnet.addressPrefix]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('bastionSubnetNSGName'))]"
                      }
                    }
                  },
                  {
                    "name": "[variables('vnetConfig').subnets.logSourceSubnet.name]",
                    "properties": {
                      "addressPrefix": "[variables('vnetConfig').subnets.logSourceSubnet.addressPrefix]",
                      "networkSecurityGroup": {
                        "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('logSourceSubnetNSGName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('bastionSubnetNSGName'))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', variables('logSourceSubnetNSGName'))]"
              ]
            }
          ]
        }
      }
    },
    {
      "condition": "[parameters('deployBastion')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Bastion', parameters('datetime'), parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "subnetResourceId": {
            "value": "[format('{0}/subnets/{1}', variables('vnetId'), variables('azureBastionSubnetName'))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "3919700818230845825"
            }
          },
          "parameters": {
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-workshop",
              "metadata": {
                "description": "Resources Name Prefix. This will be used to name most of the resources and the resource group"
              }
            },
            "subnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "Resource Id of the Azure Bastion Subnet"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            }
          },
          "variables": {
            "bastionHostName": "[format('{0}-bastion', parameters('basename'))]",
            "publicIpAddressName": "[format('{0}-pip', variables('bastionHostName'))]"
          },
          "resources": [
            {
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2022-07-01",
              "name": "[variables('publicIpAddressName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "type": "Microsoft.Network/bastionHosts",
              "apiVersion": "2022-07-01",
              "name": "[variables('bastionHostName')]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "IpConf",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetResourceId')]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpAddressName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpAddressName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-{1}-Networking', parameters('datetime'), parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deploySentinel')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Wksp', parameters('datetime'), parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceName": {
            "value": "[variables('workspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "12058674033004071607"
            }
          },
          "parameters": {
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics Workspace. This will be used to name the Log Analytics Workspace and the Sentinel Solution."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('workspaceName')]",
              "location": "[parameters('location')]"
            },
            {
              "type": "Microsoft.OperationsManagement/solutions",
              "apiVersion": "2015-11-01-preview",
              "name": "[format('SecurityInsights({0})', parameters('workspaceName'))]",
              "location": "[parameters('location')]",
              "plan": {
                "name": "[format('SecurityInsights({0})', parameters('workspaceName'))]",
                "promotionCode": "",
                "product": "OMSGallery/SecurityInsights",
                "publisher": "Microsoft"
              },
              "properties": {
                "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName'))]"
              ]
            }
          ]
        }
      }
    },
    {
      "condition": "[parameters('deployDataCollectionRule')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-DCR', parameters('datetime'), parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "basename": {
            "value": "[parameters('basename')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "workspaceResourceId": {
            "value": "[variables('workspaceId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "3750211227146150220"
            }
          },
          "parameters": {
            "basename": {
              "type": "string",
              "defaultValue": "sentinel-workshop",
              "minLength": 5,
              "maxLength": 40
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "workspaceResourceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace Resource Id"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2022-06-01",
              "name": "[format('{0}-syslog-dcr', parameters('basename'))]",
              "location": "[parameters('location')]",
              "kind": "Linux",
              "properties": {
                "dataSources": {
                  "syslog": [
                    {
                      "streams": [
                        "Microsoft-Syslog"
                      ],
                      "facilityNames": [
                        "user",
                        "auth",
                        "authpriv"
                      ],
                      "logLevels": [
                        "Info",
                        "Notice",
                        "Warning",
                        "Error",
                        "Critical",
                        "Alert",
                        "Emergency"
                      ],
                      "name": "sysLogsDataSource"
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "workspaceResourceId": "[parameters('workspaceResourceId')]",
                      "name": "DataCollectionEvent"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "Microsoft-Syslog"
                    ],
                    "destinations": [
                      "DataCollectionEvent"
                    ]
                  }
                ]
              }
            }
          ],
          "outputs": {
            "syslogDcrResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('{0}-syslog-dcr', parameters('basename')))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-{1}-Wksp', parameters('datetime'), parameters('basename')))]"
      ]
    },
    {
      "condition": "[parameters('deployLinuxLogSource')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}-{1}-Log-Source', parameters('datetime'), parameters('basename'))]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminPasswordOrKey": {
            "value": "[parameters('adminPasswordOrSSHKey')]"
          },
          "adminUsername": {
            "value": "[parameters('adminUsername')]"
          },
          "authenticationType": {
            "value": "[parameters('authenticationType')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "osVersion": {
            "value": "Ubuntu-2004"
          },
          "securityType": {
            "value": "TrustedLaunch"
          },
          "subnetResourceId": {
            "value": "[format('{0}/subnets/{1}', variables('vnetId'), variables('logSourceSubnetName'))]"
          },
          "vmName": {
            "value": "[variables('vmName')]"
          },
          "vmSize": {
            "value": "Standard_D2s_v3"
          },
          "dataCollectionRuleResourceIds": {
            "value": [
              "[reference(resourceId('Microsoft.Resources/deployments', format('{0}-{1}-DCR', parameters('datetime'), parameters('basename'))), '2022-09-01').outputs.syslogDcrResourceId.value]"
            ]
          },
          "deployAMA": {
            "value": true
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.24.24.22086",
              "templateHash": "13687696810711580786"
            }
          },
          "parameters": {
            "adminPasswordOrKey": {
              "type": "securestring",
              "metadata": {
                "description": "SSH Key or password for the Virtual Machine. SSH key is recommended."
              }
            },
            "adminUsername": {
              "type": "string",
              "metadata": {
                "description": "Username for the Virtual Machine."
              }
            },
            "authenticationType": {
              "type": "string",
              "defaultValue": "password",
              "allowedValues": [
                "sshPublicKey",
                "password"
              ],
              "metadata": {
                "description": "Type of authentication to use on the Virtual Machine. SSH key is recommended."
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location of the resources"
              }
            },
            "osVersion": {
              "type": "string",
              "defaultValue": "Ubuntu-2004",
              "allowedValues": [
                "Ubuntu-1804",
                "Ubuntu-2004",
                "Ubuntu-2204"
              ],
              "metadata": {
                "description": "The version of the Ubuntu to use for the Virtual Machine."
              }
            },
            "securityType": {
              "type": "string",
              "defaultValue": "TrustedLaunch",
              "allowedValues": [
                "Standard",
                "TrustedLaunch"
              ],
              "metadata": {
                "description": "Security Type of the Virtual Machine."
              }
            },
            "subnetResourceId": {
              "type": "string",
              "metadata": {
                "description": "The Resource Id of the subnet to use for the virtual machine"
              }
            },
            "vmName": {
              "type": "string",
              "defaultValue": "LinuxLogSource",
              "metadata": {
                "description": "The name of your Virtual Machine."
              }
            },
            "vmSize": {
              "type": "string",
              "defaultValue": "Standard_D2s_v3",
              "metadata": {
                "description": "The size of the VM"
              }
            },
            "_artifactsLocation": {
              "type": "string",
              "defaultValue": "[deployment().properties.templateLink.uri]",
              "metadata": {
                "description": "The base URI where artifacts required by this template are located. When the template is deployed using the accompanying scripts, a private location in the subscription will be used and this value will be automatically generated."
              }
            },
            "_artifactsLocationSasToken": {
              "type": "securestring",
              "metadata": {
                "description": "The sasToken required to access _artifactsLocation.  When the template is deployed using the accompanying scripts, a sasToken will be automatically generated."
              }
            },
            "deployAMA": {
              "type": "bool",
              "defaultValue": true
            },
            "dataCollectionRuleResourceIds": {
              "type": "array",
              "defaultValue": []
            }
          },
          "variables": {
            "copy": [
              {
                "name": "scriptFilesUris",
                "count": "[length(variables('scriptFiles'))]",
                "input": "[uri(parameters('_artifactsLocation'), format('{0}{1}', variables('scriptFiles')[copyIndex('scriptFilesUris')], parameters('_artifactsLocationSasToken')))]"
              },
              {
                "name": "dcrResourceAssociations",
                "count": "[length(parameters('dataCollectionRuleResourceIds'))]",
                "input": {
                  "dataCollectionRuleName": "[format('{0}-dcrassociation', guid(parameters('dataCollectionRuleResourceIds')[copyIndex('dcrResourceAssociations')]))]",
                  "dataCollectionRuleId": "[parameters('dataCollectionRuleResourceIds')[copyIndex('dcrResourceAssociations')]]"
                }
              }
            ],
            "customScriptExtension": {
              "name": "CustomScript",
              "properties": {
                "publisher": "Microsoft.Azure.Extensions",
                "type": "CustomScript",
                "typeHandlerVersion": "2.1",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "commandToExecute": "./config.sh",
                  "fileUris": "[variables('scriptFilesUris')]"
                }
              }
            },
            "imageReference": {
              "Ubuntu-1804": {
                "publisher": "Canonical",
                "offer": "UbuntuServer",
                "sku": "18_04-lts-gen2",
                "version": "latest"
              },
              "Ubuntu-2004": {
                "publisher": "Canonical",
                "offer": "0001-com-ubuntu-server-focal",
                "sku": "20_04-lts-gen2",
                "version": "latest"
              },
              "Ubuntu-2204": {
                "publisher": "Canonical",
                "offer": "0001-com-ubuntu-server-jammy",
                "sku": "22_04-lts-gen2",
                "version": "latest"
              }
            },
            "linuxConfiguration": {
              "disablePasswordAuthentication": true,
              "ssh": {
                "publicKeys": [
                  {
                    "path": "[format('/home/{0}/.ssh/authorized_keys', parameters('adminUsername'))]",
                    "keyData": "[parameters('adminPasswordOrKey')]"
                  }
                ]
              }
            },
            "networkInterfaceName": "[format('{0}NetInt', parameters('vmName'))]",
            "osDiskType": "Standard_LRS",
            "scriptFiles": [
              "LinuxLogSource/Config/config.sh",
              "LinuxLogSource/Config/rsyslog-50-default.conf"
            ],
            "securityProfileJson": {
              "uefiSettings": {
                "secureBootEnabled": true,
                "vTpmEnabled": true
              },
              "securityType": "[parameters('securityType')]"
            },
            "trustedLaunchExtension": {
              "extensionName": "GuestAttestation",
              "properties": {
                "publisher": "Microsoft.Azure.Security.LinuxAttestation",
                "type": "GuestAttestation",
                "typeHandlerVersion": "1.0",
                "autoUpgradeMinorVersion": true,
                "enableAutomaticUpgrade": true,
                "settings": {
                  "AttestationConfig": {
                    "MaaSettings": {
                      "maaEndpoint": "[substring('emptystring', 0, 0)]",
                      "maaTenantName": "GuestAttestation"
                    }
                  }
                }
              }
            },
            "azureMonitorAgentLinuxExtension": {
              "extensionName": "AzureMonitorLinuxAgent",
              "properties": {
                "publisher": "Microsoft.Azure.Monitor",
                "type": "AzureMonitorLinuxAgent",
                "typeHandlerVersion": "1.27",
                "autoUpgradeMinorVersion": true,
                "enableAutomaticUpgrade": true
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2023-05-01",
              "name": "[variables('networkInterfaceName')]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig1",
                    "properties": {
                      "subnet": {
                        "id": "[parameters('subnetResourceId')]"
                      },
                      "privateIPAllocationMethod": "Dynamic"
                    }
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2021-11-01",
              "name": "[parameters('vmName')]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "hardwareProfile": {
                  "vmSize": "[parameters('vmSize')]"
                },
                "storageProfile": {
                  "osDisk": {
                    "createOption": "FromImage",
                    "managedDisk": {
                      "storageAccountType": "[variables('osDiskType')]"
                    }
                  },
                  "imageReference": "[variables('imageReference')[parameters('osVersion')]]"
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
                    }
                  ]
                },
                "osProfile": {
                  "computerName": "[parameters('vmName')]",
                  "adminUsername": "[parameters('adminUsername')]",
                  "adminPassword": "[parameters('adminPasswordOrKey')]",
                  "linuxConfiguration": "[if(equals(parameters('authenticationType'), 'password'), null(), variables('linuxConfiguration'))]"
                },
                "securityProfile": "[if(equals(parameters('securityType'), 'TrustedLaunch'), variables('securityProfileJson'), null())]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
              ]
            },
            {
              "condition": "[and(equals(parameters('securityType'), 'TrustedLaunch'), and(equals(variables('securityProfileJson').uefiSettings.secureBootEnabled, true()), equals(variables('securityProfileJson').uefiSettings.vTpmEnabled, true())))]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('vmName'), variables('trustedLaunchExtension').extensionName)]",
              "location": "[parameters('location')]",
              "properties": "[variables('trustedLaunchExtension').properties]",
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
              ]
            },
            {
              "condition": "[parameters('deployAMA')]",
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-11-01",
              "name": "[format('{0}/{1}', parameters('vmName'), variables('azureMonitorAgentLinuxExtension').extensionName)]",
              "location": "[parameters('location')]",
              "properties": "[variables('azureMonitorAgentLinuxExtension').properties]",
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",
                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), variables('trustedLaunchExtension').extensionName)]"
              ]
            },
            {
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2022-03-01",
              "name": "[format('{0}/{1}', parameters('vmName'), variables('customScriptExtension').name)]",
              "location": "[parameters('location')]",
              "properties": "[variables('customScriptExtension').properties]",
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",
                "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), variables('azureMonitorAgentLinuxExtension').extensionName)]"
              ]
            },
            {
              "copy": {
                "name": "dcrAssociation",
                "count": "[length(variables('dcrResourceAssociations'))]"
              },
              "type": "Microsoft.Insights/dataCollectionRuleAssociations",
              "apiVersion": "2021-04-01",
              "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('vmName'))]",
              "name": "[variables('dcrResourceAssociations')[copyIndex()].dataCollectionRuleName]",
              "properties": {
                "dataCollectionRuleId": "[variables('dcrResourceAssociations')[copyIndex()].dataCollectionRuleId]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}-{1}-DCR', parameters('datetime'), parameters('basename')))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}-{1}-Networking', parameters('datetime'), parameters('basename')))]"
      ]
    }
  ]
}